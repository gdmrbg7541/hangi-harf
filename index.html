<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Doğru Harfi Seç</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Harmattan:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Marhey:wght@300..700&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            overflow: hidden; /* Body'nin kaymasını genel olarak engelle */
        }
        body {
            font-family: 'Marhey', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; /* Marhey Font */
            padding: 1rem; padding-top: 1rem;
            background-image: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            background-attachment: fixed; background-size: 200% 200%;
            animation: background-pan 15s ease infinite;
            overscroll-behavior-y: contain;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        @keyframes background-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Arapça Font Önceliği */
        [lang="ar"], .word, .option span { font-family: 'Arakom', 'Harmattan', system-ui, sans-serif; direction: rtl; }

        body, button, h1, h2, h3, p, div:not([lang="ar"]) { direction: ltr; }
        #back-btn {
            position: fixed; top: 1rem; left: 1rem; z-index: 3000; width: 48px; height: 48px;
            background-color: rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #back-btn svg { width: 24px; height: 24px; }

        #game-wrapper {
            width: 100%;
            max-width: 1200px; /* Geniş ekranlar için maksimum genişlik */
            max-height: 95vh; /* viewport'un %95'i gibi bir sınır */
            /* display: flex; */
            flex-direction: row; /* Masaüstü varsayılan */
            gap: 1rem; /* player-screen'ler arası boşluk */
        }

        #top-progress-bar {
            display: none;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 1rem auto;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            padding: 0 0.5rem;
            flex-shrink: 0;
            direction: rtl; /* Sağdan sola ilerleme */
        }
        .progress-word { height: 8px; background-color: rgba(255, 255, 255, 0.4); border-radius: 4px; transition: background-color 0.3s ease; }
        .progress-word.correct { background-color: #28a745; } .progress-word.incorrect { background-color: #dc3545; }
        .player-screen {
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            border-radius: 1.5rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            flex-grow: 1;
            flex-basis: 0;
            min-height: 0;
            justify-content: space-between;
        }
        #player-1 { background-color: rgba(227, 242, 253, 0.5); } #player-2 { background-color: rgba(255, 243, 224, 0.5); }
        body.mode-1p #player-2 { display: none; } body.mode-1p #player-1 { width: 100%; max-width: 800px; margin: 0 auto; } body.mode-1p #game-wrapper { justify-content: center; } body.mode-1p #player-1 .player-icon-wrapper { display: none; } body.mode-1p #top-progress-bar { display: grid; order: -1; } body.mode-1p #player-1 #progress-1 { display: none; } body.mode-1p #player-2 #progress-2 { display: none; }

        body.mode-1p #player-1 .status-bar { justify-content: flex-end; }
        body.mode-1p #p1-timer { display: flex; } /* 'hidden' kalkınca flex olsun */
        body.mode-1p #p1-score-wrapper { margin-right: auto; } /* Puanı sola it */

        #modal.mode-1p #result-column-2 { display: none; } #modal.mode-1p .results-grid { grid-template-columns: 1fr; max-width: 400px; margin-left: auto; margin-right: auto; }
        body.mode-2p #player-1, body.mode-2p #player-2 { width: 50%; } #modal.mode-2p .results-grid { grid-template-columns: 1fr; } /* Varsayılan 1 sütun */ body.mode-2p #top-progress-bar { display: none; }
        body.mode-2p #progress-1, body.mode-2p #progress-2 {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            width: 100%;
            max-width: 300px;
            margin: 0.5rem auto 1rem auto;
            flex-shrink: 0;
            direction: rtl; /* Sağdan sola ilerleme */
        }
        body.mode-2p .progress-word { height: 8px; border-radius: 4px; }
        body.mode-2p .status-bar { justify-content: flex-end; }

        .player-icon-wrapper .flex {
            align-items: center; /* Dikey hizalama */
            line-height: 1; /* H1'deki ekstra boşluğu azaltmak için */
        }
        .player-icon-wrapper h1 {
            direction: ltr;
            font-size: 2.5em;
            line-height: 1; /* Dikey boşluğu kaldır */
        }
        .player-icon-wrapper svg {
            width: 1em;  /* Font boyutuna göre ölçeklen */
            height: 1em; /* Font boyutuna göre ölçeklen */
            font-size: 2.5em; /* H1 ile aynı em değeri */
        }


        .question-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Dikey Ortalama */
            align-items: center;
            gap: 1rem;
            order: 0;
            overflow-y: auto; /* İçerik Kaydırma */
            min-height: 0;
            padding-bottom: 1rem; /* Alt boşluk */
        }
        .word { font-size: clamp(2.5rem, 10vw, 5rem); color: #1f2937; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); font-weight: 700; }
        .options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; width: 100%; max-width: 400px; }
        .option { background-color: #ffffff; border: 1px solid rgba(0, 0, 0, 0.05); color: #1f2937; border-radius: 1rem; padding: 1rem; text-align: center; font-size: clamp(1.8rem, 8vw, 3rem); cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.08); } .option:hover { background-color: #f8f9fa; transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,0,0,0.12); } .option:active { transform: scale(0.98); transition-duration: 0.1s; } .option.correct { background-color: #d4edda; border-color: #28a745; } .option.incorrect { background-color: #f8d7da; border-color: #dc3545; } .option.disabled { pointer-events: none; opacity: 0.7; } .option span { color: #111827; font-weight: 700; }
        .status-bar {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.25);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            font-size: 1.25rem;
            position: relative;
            flex-shrink: 0;
        }
        #modal { position: fixed; inset: 0; z-index: 1000; overflow-y: auto; padding: 1rem; display: none; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); } .modal-content { background-color: white; padding: 2rem; border-radius: 1.5rem; text-align: center; width: 95%; max-width: 800px; position: relative; margin: auto; max-height: 90vh; overflow-y: auto; } .results-grid { display: grid; gap: 1rem; margin-top: 1.5rem; } .result-column { padding: 1rem; border-radius: 1rem; position: relative; overflow: hidden; }
        .result-item { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .intro-screen { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; padding: 1rem; overflow-y: auto; } .info-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1.5rem; padding: 2rem; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2); }
        .difficulty-btn { padding: 0.8rem 2rem; font-size: 1.5rem; color: white; border-radius: 0.75rem; transition: all 0.2s; width: 100%; max-width: 384px; } .difficulty-btn.easy { background-color: #22c55e; } .difficulty-btn.easy:hover { background-color: #16a34a; } .difficulty-btn.medium { background-color: #f97316; } .difficulty-btn.medium:hover { background-color: #ea580c; } .difficulty-btn.hard { background-color: #ef4444; } .difficulty-btn.hard:hover { background-color: #dc2626; }
        .modal-secondary-btn { font-size: 1.25rem; font-weight: 600; padding: 0.75rem 1.5rem; background-color: #f3f4f6; color: #1f2937; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.2s ease; } .modal-secondary-btn:hover { background-color: #e5e7eb; }
        #countdown-overlay { font-size: clamp(8rem, 30vw, 15rem); color: white; font-weight: bold; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .player-screen.flash-correct { animation: flash-green 0.6s ease-out; } .player-screen.incorrect-answer-effect { animation: shake-and-flash-red 0.6s ease-out; } @keyframes flash-green { 0%, 100% { background-color: rgba(227, 242, 253, 0.5); } 50% { background-color: rgba(40, 167, 69, 0.5); } } #player-2.flash-correct { animation: flash-green-p2 0.6s ease-out; } @keyframes flash-green-p2 { 0%, 100% { background-color: rgba(255, 243, 224, 0.5); } 50% { background-color: rgba(40, 167, 69, 0.5); } } @keyframes shake-and-flash-red { 0% { transform: translateX(0); background-color: rgba(227, 242, 253, 0.5); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } 50% { background-color: rgba(220, 53, 69, 0.5); } 100% { transform: translateX(0); background-color: rgba(227, 242, 253, 0.5); } } #player-2.incorrect-answer-effect { animation: shake-and-flash-red-p2 0.6s ease-out; } @keyframes shake-and-flash-red-p2 { 0% { transform: translateX(0); background-color: rgba(255, 243, 224, 0.5); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } 50% { background-color: rgba(220, 53, 69, 0.5); } 100% { transform: translateX(0); background-color: rgba(255, 243, 224, 0.5); } }
        .flying-char { position: absolute; font-size: 3rem; font-weight: 700; color: #1f2937; opacity: 1; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.6s ease-out; z-index: 10; pointer-events: none; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .score-popup { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); font-size: 2.5rem; font-weight: bold; color: #ffc107; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); animation: score-anim 1.2s ease-out forwards; pointer-events: none; z-index: 20; } @keyframes score-anim { 0% { opacity: 1; transform: translate(-50%, 0) scale(0.8); } 50% { transform: translate(-50%, -40px) scale(1.1); } 100% { opacity: 0; transform: translate(-50%, -80px) scale(0.9); } }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: red; opacity: 0; animation: fall 4s linear infinite; } @keyframes fall { 0% { transform: translateY(-100vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; } }

        @media (min-width: 768px) {
            /* Tablet ve üstü için 2 sütunlu sonuç */
            #modal.mode-2p .results-grid { grid-template-columns: 1fr 1fr; }
        }

        /* MOBİL GÖRÜNÜM AYARLARI */
        @media (max-width: 900px) {
             body {
                padding: 1rem 0.5rem;
                justify-content: center;
            }

            #back-btn { top: 0.5rem; left: 0.5rem; width: 40px; height: 40px; }
            #back-btn svg { width: 20px; height: 20px; }
            #game-wrapper{
                flex-direction: column;
                gap: 0.5rem;
                max-height: 90vh; /* Mobil dikey yükseklik sınırı */
            }
            .player-screen{
                /* Dikey padding azaltıldı */
                padding: 0.5rem 0.75rem;
                width: 100% !important;
                max-width: 100% !important;
                flex-grow: 1; /* Alanı doldur */
                min-height: 0; /* Küçülmeye izin ver */
            }
            body.mode-2p .player-screen {
                 flex-basis: 0; /* Eşit böl */
            }

            .player-icon-wrapper h1 {
                font-size: 2em; /* Mobil için biraz daha küçük */
            }
            .player-icon-wrapper svg {
                font-size: 2em; /* Mobil için biraz daha küçük */
            }

            /* Dikey boşluklar azaltıldı */
            .question-container { gap: 0.3rem; padding-bottom: 0.3rem; }
            /* Minimum font boyutu azaltıldı */
            .word { font-size: clamp(1.8rem, 8vw, 3.5rem); }
            .options { gap: 0.5rem; }
            /* Padding, min font boyutu ve min yükseklik azaltıldı */
            .option { padding: 0.4rem; font-size: clamp(1.4rem, 7vw, 2.2rem); min-height: 44px;}
            /* Dikey padding azaltıldı */
            .status-bar { padding: 0.3rem 0.6rem; font-size: 0.9rem; }
            /* Dikey margin azaltıldı */
            body.mode-2p #progress-1, body.mode-2p #progress-2 { gap: 2px; max-width: 150px; margin: 0.3rem auto 0.5rem auto; }
            body.mode-2p .progress-word { height: 4px; border-radius: 2px; }
            /* Alt margin azaltıldı */
            #top-progress-bar { margin-bottom: 0.4rem; padding: 0 0.25rem; gap: 2px; }
            .progress-word { height: 5px; border-radius: 2.5px; }
            .modal-content{ padding: 1rem; width: 95%; max-height: 85vh; }
            .results-grid { margin-top: 0.75rem; }
            .result-column { padding: 0.5rem; }
            .result-item { font-size: 1.2rem; gap: 0.4rem; }
            #modal-buttons { flex-direction: column; align-items: center; margin-top: 1rem; }
            .modal-secondary-btn { font-size: 1rem; width: 100%; max-width: 200px; padding: 0.6rem 1rem; }
            h1 { font-size: 2rem !important; }
            h2 { font-size: 1.5rem !important; }
            h3:not([lang="ar"]) { font-size: 1.2rem !important; }
            p { font-size: 1rem !important; }
        }
        /* ... diğer kurallar ... */
        .result-column h3 { font-family: 'Marhey', system-ui, sans-serif; } /* Marhey Font */
        .result-item span:first-child { direction: rtl; }
        .result-item span:nth-child(2) { direction: rtl; }
    </style>
</head>

<body>
    <div id="back-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </div>

    <div id="rules-screen" class="intro-screen">
        <div class="w-full max-w-xl mx-auto px-4 text-center">
            <div class="info-card">
                <h1 class="text-4xl md:text-5xl lg:text-7xl font-bold text-gray-800 mb-4" style="text-shadow: 0 2px 10px rgba(0,0,0,0.1);">Doğru Harfi Seç</h1>
                <p class="text-xl md:text-2xl lg:text-3xl text-gray-600 mt-4 mb-8 md:mb-12">Oyun Modunu Seçin</p>
                <div class="flex flex-col gap-4 md:gap-6 items-center">
                    <button id="start-1p-btn" class="group flex items-center justify-center gap-3 w-full max-w-sm px-6 py-4 bg-white/80 backdrop-blur-sm border border-white/50 rounded-xl shadow-lg transition-all duration-300 hover:bg-white hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500/70">
                        <svg class="w-8 h-8 text-blue-800 transition-transform duration-300 group-hover:scale-110" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a5 5 0 0 0-5 5a5 5 0 0 0 5 5a5 5 0 0 0 5-5a5 5 0 0 0-5-5M8 16c-1.6 0-3.08.38-4.32.97A7.32 7.32 0 0 0 12 21.5a7.32 7.32 0 0 0 8.32-4.53A13.06 13.06 0 0 0 16 16Z"></path></svg>
                        <span class="text-left"><span class="text-2xl md:text-3xl block font-semibold text-blue-900">1 Kişilik</span><span class="text-base md:text-lg block font-normal text-blue-800/80">Zamana Karşı Yarış</span></span>
                    </button>
                    <button id="start-2p-btn" class="group flex items-center justify-center gap-3 w-full max-w-sm px-6 py-4 bg-blue-700 rounded-xl shadow-lg transition-all duration-300 hover:bg-blue-800 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <svg class="w-8 h-8 text-white transition-transform duration-300 group-hover:scale-110" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13a3 3 0 0 0-3-3a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3m5.61.16A13.06 13.06 0 0 0 20 16c-1.6 0-3.08.38-4.32.97A7.32 7.32 0 0 0 12 21.5a7.32 7.32 0 0 0 8.32-4.53A13.06 13.06 0 0 0 16 16c.64 0 1.25.07 1.84.16M12 4a5 5 0 0 0-5 5a5 5 0 0 0 5 5a5 5 0 0 0 5-5a5 5 0 0 0-5-5M8 16c-1.6 0-3.08.38-4.32.97A7.32 7.32 0 0 0 12 21.5a7.32 7.32 0 0 0 8.32-4.53A13.06 13.06 0 0 0 16 16c-1.6 0-3.08.38-4.32.97A7.32 7.32 0 0 0 4 16.97A13.06 13.06 0 0 0 2.39 13.16C2.14 13.41 2 13.7 2 14v4a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-4c0-.3-.14-.59-.39-.84Z"></path></svg>
                        <span class="text-left"><span class="text-2xl md:text-3xl block font-semibold text-white">2 Kişilik</span><span class="text-base md:text-lg block font-normal text-blue-100/90">Arkadaşınla Yarış</span></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="difficulty-screen" class="intro-screen hidden">
        <div class="w-full max-w-xl mx-auto px-4 text-center">
            <div class="info-card">
                <h1 class="text-4xl md:text-5xl lg:text-7xl font-bold text-gray-800 mb-4">Zorluk Seçin</h1>
                <p class="text-xl md:text-2xl lg:text-3xl text-gray-600 mt-4 mb-8 md:mb-12">20 Kelimeyi Tamamla</p>
                <div class="flex flex-col gap-4 md:gap-6 items-center">
                    <button id="easy-btn" class="difficulty-btn easy"><span class="text-2xl md:text-3xl block">Kolay</span></button>
                    <button id="medium-btn" class="difficulty-btn medium"><span class="text-2xl md:text-3xl block">Orta</span></button>
                    <button id="hard-btn" class="difficulty-btn hard"><span class="text-2xl md:text-3xl block">Zor</span></button>
                </div>
            </div>
        </div>
    </div>

    <div id="countdown-overlay" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 hidden"><span id="countdown-number"></span></div>


    <div id="game-wrapper" class="hidden flex">
        <div id="player-1" class="w-full md:w-1/2 player-screen">
            <div class="w-full flex justify-center player-icon-wrapper">
                <div class="flex gap-2 md:gap-3">
                    <svg style="fill: #005f9e;" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.84,8c18.84-32.56,52.14-52,89.08-52s70.24,19.44,89.08,52a8,8,0,1,0,13.84-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg>
                    <h1 class="font-bold" style="color: #005f9e;">2</h1>
                </div>
            </div>
            <div id="top-progress-bar"></div><div id="progress-1"></div>
            <div class="question-container"><div id="word-1" class="word" lang="ar">...</div><div id="options-1" class="options" lang="ar"></div></div>

            <div class="status-bar">
                <div id="p1-score-wrapper" class="flex items-center gap-1 md:gap-2 text-xl md:text-2xl">
                    <span class="text-2xl md:text-3xl">⭐</span><span id="score-1">0</span>
                </div>
                <div id="p1-timer" class="hidden items-center gap-1 md:gap-2 text-xl md:text-2xl">
                    <span class="text-2xl md:text-3xl">⏱️</span><span id="p1-timer-value"></span>
                </div>
            </div>
        </div>
         <div id="player-2" class="w-full md:w-1/2 player-screen">
            <div class="w-full flex justify-center player-icon-wrapper">
                <div class="flex gap-2 md:gap-3">
                    <svg style="fill: #c57d00;" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.84,8c18.84-32.56,52.14-52,89.08-52s70.24,19.44,89.08,52a8,8,0,1,0,13.84-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg>
                    <h1 class="font-bold" style="color: #c57d00;">1</h1>
                </div>
            </div>
            <div id="progress-2"></div>
            <div class="question-container"><div id="word-2" class="word" lang="ar">...</div><div id="options-2" class="options" lang="ar"></div></div>
            <div class="status-bar"><div class="flex items-center gap-1 md:gap-2 text-xl md:text-2xl"><span class="text-2xl md:text-3xl">⭐</span><span id="score-2">0</span></div></div>
        </div>
    </div>

    <div id="modal" class="items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-60" style="backdrop-filter: blur(4px);"></div>
        <div class="modal-content relative">
            <div id="results-wrapper">
                <h2 id="winner-text" class="text-2xl md:text-3xl font-bold mb-4"></h2> <div id="results-container">
                    <div class="results-grid">
                        <div id="result-column-1" class="result-column" style="background-color: #e3f2fd;"><h3 class="text-xl md:text-2xl lg:text-3xl font-bold mb-3 text-center" lang="tr">Oyuncu 2</h3><div id="player-1-results" class="flex flex-col items-start" lang="ar"></div></div>
                        <div id="result-column-2" class="result-column" style="background-color: #fff3e0;"><h3 class="text-xl md:text-2xl lg:text-3xl font-bold mb-3 text-center" lang="tr">Oyuncu 1</h3><div id="player-2-results" class="flex flex-col items-start" lang="ar"></div></div>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <script>
        // KELİME LİSTESİ GÜNCELLENDİ (HAREKESİZ & HATALAR DÜZELTİLDİ)
        const wordsByLetterWithHarakat = {
             'ب': ['باب', 'خبز', 'كتاب', 'طبيب', 'بيت', 'مكتب', 'سبورة', 'حقيبة', 'شباك', 'ثلاجة', 'مصباح', 'يكتب', 'يطبخ', 'أعمال البيت', 'يلبس الملابس', 'يتناول الفطور', 'يكتب الواجب', 'واجب', 'مبكرا', 'يحب', 'البيت السعيد', 'أب', 'أبناء', 'طيب', 'مبتسم', 'غضوب', 'أحب', 'مباريات', 'يجب أن', 'سبب النجاح', 'يتجنب المرض', 'جسم قوي', 'جبن', 'بيض', 'بطيخ', 'بصل', 'بيضة', 'أبيض'],
             'ت': ['اكتب', 'اكتبي', 'تحت', 'مكتب', 'دفتر', 'مسطرة', 'بيت', 'مطبخ', 'مرحاض', 'ستارة', 'متى', 'يتناول الفطور', 'يكتب الواجب', 'الكتاب', 'أتغدى', 'أكتب', 'أخت', 'احترام', 'طاعة', 'البيت السعيد', 'يتحدثون', 'يتعاونون', 'مستقبل', 'متواضع', 'كتابة', 'مكتبة', 'الوقت الفارغ', 'ممتع', 'وقتي', 'استراحة', 'يكتب', 'متأخرا', 'تخطيط', 'وقت', 'مستقبل', 'عادة', 'تطوير النفس', 'أسنان', 'متوازن', 'تمساح', 'تفاح', 'بنت', 'تمر', 'مفتاح', 'ثلاثة', 'أثاث', 'تلميذ'],
             'ث': ['ثلاجة', 'مثلث', 'ثلاثة', 'أثاث', 'ثوب', 'ثعلب', 'يتحدثون'],
             'ج': ['جبل', 'دجاجة', 'شجرة', 'مسجد', 'ثلج', 'حاجة', 'خروج', 'جديد', 'يجلس', 'سجادة', 'ثلاجة', 'يخرج', 'راجع', 'مجتهد', 'جنس', 'نجاح', 'جرح', 'وجه', 'جسم قوي', 'جبن', 'وجبة', 'الغداء', 'العشاء', 'جدي', 'جمل', 'خارج', 'يرجع', 'جيد'],
             'ح': ['صباح الخير', 'مرحبا', 'الحمد لله', 'حقيبة', 'مفتاح', 'تمساح', 'ملح', 'لوح', 'حمام', 'مرحاض', 'سطح', 'يحمل', 'صحة', 'جرح', 'يستحم', 'عادات صحية', 'الحياة الصحية', 'صحي', 'النصيحة', 'صحة', 'جسم سليم', 'حاضر', 'حكمة', 'الحسنة', 'حالك', 'فطور', 'الحب', 'فرح'],
             'خ': ['صباح الخير', 'أنا بخير', 'خبز', 'خروف', 'نخلة', 'مطبخ', 'خوخ', 'بطيخ', 'خلف', 'خارج', 'يخرج', 'يدخل', 'أخ', 'خال', 'خالة', 'إخلاص', 'آخرين', 'أخي', 'الخبز', 'الخضراوات', 'متأخرا', 'يخطط', 'تخطيط'],
             'د': ['ديك', 'مدرسة', 'يد', 'جديد', 'أسد', 'الحمد لله', 'أعد', 'أعيدي', 'مدرس', 'صديق', 'والدان', 'جد', 'جدة', 'يد الوالدين', 'مجتهد', 'هادئ', 'أريد أن', 'مهندس', 'عدد', 'دائما', 'جدول', 'يدرس', 'نادرا', 'إبداع', 'جد', 'يضيع الوقت', 'يدان', 'دواء', 'بأدب', 'الوالدين', 'دولاب', 'دروس'],
             'ذ': ['ذرة', 'أذن', 'تلميذ', 'لذيذ', 'ذهب', 'اذهب', 'أخذ', 'اعتذار', 'يؤذي', 'الغذاء', 'يأخذ'],
             'ر': ['اقرأ', 'اقرئي', 'صباح الخير', 'مرحبا', 'شكرا', 'كرسي', 'أرنب', 'جزر', 'فرس', 'صورة', 'مريض', 'أرض', 'غرفة', 'سرير', 'مروحة', 'يقرأ', 'فرن', 'يرتب', 'مرآة', 'مرتب', 'يرجع', 'يستريح', 'يقرأ الكتاب', 'مبكرا', 'أراجع دروسي', 'احترام', 'رحمة', 'صبر', 'آخرين', 'الكبار', 'الصغار', 'مر', 'أقارب', 'أسرة', 'تراحم', 'يزور الأقارب', 'عمر', 'أريد أن', 'قراءة', 'رسم', 'رياضة', 'كرة القدم', 'كرة سلة', 'سفر', 'يقرأ', 'يرسم', 'يسافر', 'يصور', 'في الوقت الفارغ', 'الفراغ', 'استراحة', 'يدرس', 'يستريح', 'نادر', 'شرب', 'يرتب', 'سريري', 'أراجع دروسي', 'مرض', 'رياضة', 'يفرش الأسنان', 'يشرب الماء', 'يمارس الرياضة', 'يزور الطبيب', 'العصير', 'السريع', 'المشروبات الغازية', 'أرتب سريري', 'أراجع دروسي', 'رأس', 'قمر', 'نهر', 'مدرس'],
             'ز': ['زرافة', 'ميزان', 'خبز', 'موز', 'جزر', 'تلفاز', 'أزور جدي', 'اعتذار', 'يعتذر', 'يزور الأقارب', 'عزف', 'متوازن', 'غازية', 'فطور'],
             'س': ['السلام عليكم', 'وعليكم السلام', 'صباح النور', 'مساء الخير', 'أهلا وسهلا', 'اسمك', 'اسمي', 'اسكت', 'مدرس', 'مدرسة', 'كرسي', 'مكتب', 'مسطرة', 'يجلس', 'يغسل', 'مغسلة', 'نفسي', 'كسول', 'مبتسم', 'مستقبل', 'مهندس', 'فنان', 'رسم', 'كرة سلة', 'موسيقى', 'يسافر', 'أستمتع بـ', 'فسحة', 'يدرس', 'يستريح', 'المساء', 'أسبوع', 'مسابقة', 'يستغل الوقت', 'ماضي', 'سبب النجاح', 'تطوير النفس', 'الجسم', 'أسنان', 'يغسل', 'يفرش الأسنان', 'يستحم', 'يمارس الرياضة', 'جسم قوي', 'نوم كاف', 'أكل متوازن', 'السمك', 'العصير', 'الدسم', 'السريع', 'المشروبات الغازية', 'جسم سليم', 'عقل سليم', 'السمنة', 'المسجد', 'لسان', 'سمكة', 'شمس'],
             'ش': ['شباك', 'شجرة', 'شمس', 'عش', 'فراشة', 'مشمش', 'شكر', 'يشكر', 'يشاهد التلفاز', 'أشاهد التلفاز', 'شخصية', 'نشيط', 'مشاهدة', 'يشاهد', 'يشرب الماء', 'الحياة النشيطة', 'المشروبات الغازية', 'العشاء', 'تشرفت', 'شخصية'],
             'ص': ['صباح الخير', 'صباح النور', 'صديق', 'صورة', 'قميص', 'بصل', 'مقصف', 'صقر', 'يصلي', 'أصلي', 'صلاة الظهر', 'صبر', 'يصبر', 'الصغار', 'الصغار', 'شخصية', 'صبور', 'تصوير', 'يصور', 'في الصباح', 'يصبر', 'الحياة الصحية', 'صحة', 'عادات صحية', 'الطعام الصحي', 'العصير', 'النصيحة', 'الصحة', 'الصلاة'],
             'ض': ['مريض', 'أبيض', 'بيضة', 'أرض', 'غضوب', 'أفضل', 'رياضة', 'يضيع الوقت', 'مرض', 'يتجنب المرض', 'أيضا', 'بعض', 'ضابط'],
             'ا': ['السلام عليكم', 'انا', 'اهلا وسهلا', 'بابا', 'حالك', 'طاولة', 'هاتف', 'ثلاجة', 'دائما', 'نادرا', 'احيانا', 'ماذا', 'اقرا', 'اكتبي', 'اذهب', 'الله', 'اللقاء', 'امان', 'الى', 'أنا'], // 'أنا' eklendi
             'و': ['هو', 'وعليكم السلام', 'فوق', 'دولاب', 'وقت', 'يوم', 'اسبوع', 'طاولة', 'ضوء', 'وردة', 'ولد', 'واجب', 'واحد', 'وجه', 'وسخ', 'الوقت', 'نوم', 'صورة', 'خوخ', 'موز', 'عفوا', 'الواجب'],
             'أ': ['أنا', 'أهلا وسهلا', 'أهلا بك', 'أنا بخير', 'أمان', 'اقرأ', 'اقرئي', 'أعد', 'أعيدي', 'أنت', 'أنا', 'أين', 'أنا من', 'أنا أيضا', 'أين', 'أمام', 'أعمال البيت', 'أحيانا', 'أستيقظ', 'أتغدى', 'أقرأ', 'أكتب', 'ألعب', 'أشاهد التلفاز', 'أساعد', 'أزور جدي', 'أذهب إلى المسجد', 'أرتب سريري', 'أنظف غرفتي', 'أراجع دروسي', 'أنام متأخرا', 'أمانة', 'أحد', 'أب', 'أم', 'أخ', 'أخت', 'أقارب', 'أبناء', 'أهل', 'أكتشف نفسي', 'أنا', 'أحب', 'أكره', 'أفضل', 'أحلامي', 'أهدافي', 'أريد أن أكون', 'أفلام', 'أستمتع بـ', 'أحيانا', 'أسبوع', 'أعمال', 'أجل', 'أسنان', 'أكل متوازن', 'أسد', 'أذن', 'أرض', 'أبيض'] // Kelimeler eklendi
         };

        const letterForms = {
            'ب': ['بـ', 'ـبـ', 'ـب', 'ب'], 'ت': ['تـ', 'ـتـ', 'ـت', 'ت'], 'ث': ['ثـ', 'ـثـ', 'ـث', 'ث'],
            'ج': ['جـ', 'ـجـ', 'ـج', 'ج'], 'ح': ['حـ', 'ـحـ', 'ـح', 'ح'], 'خ': ['خـ', 'ـخـ', 'ـخ', 'خ'],
            'د': ['د', 'ـد'], 'ذ': ['ذ', 'ـذ'], 'ر': ['ر', 'ـر'], 'ز': ['ز', 'ـز'],
            'س': ['سـ', 'ـسـ', 'ـس', 'س'], 'ش': ['شـ', 'ـشـ', 'ـش', 'ش'], 'ص': ['صـ', 'ـصـ', 'ـص', 'ص'],
            'ض': ['ضـ', 'ـضـ', 'ـض', 'ض'], 'ا': ['ا', 'ـا'], 'أ': ['أ', 'ـأ'], 'و': ['و', 'ـو']
        };

        // DOM Elementleri
        const players = { '1': { el: document.getElementById('player-1'), wordEl: document.getElementById('word-1'), optionsEl: document.getElementById('options-1'), scoreEl: document.getElementById('score-1'), progressEl: document.getElementById('progress-1'), resultsEl: document.getElementById('player-1-results') }, '2': { el: document.getElementById('player-2'), wordEl: document.getElementById('word-2'), optionsEl: document.getElementById('options-2'), scoreEl: document.getElementById('score-2'), progressEl: document.getElementById('progress-2'), resultsEl: document.getElementById('player-2-results') } };
        const modal = document.getElementById('modal'); const winnerText = document.getElementById('winner-text'); const gameWrapper = document.getElementById('game-wrapper'); const rulesScreen = document.getElementById('rules-screen'); const start1PBtn = document.getElementById('start-1p-btn'); const start2PBtn = document.getElementById('start-2p-btn'); const countdownOverlay = document.getElementById('countdown-overlay'); const countdownNumber = document.getElementById('countdown-number'); const resultsWrapper = document.getElementById('results-wrapper'); const backBtn = document.getElementById('back-btn'); const difficultyScreen = document.getElementById('difficulty-screen'); const easyBtn = document.getElementById('easy-btn'); const mediumBtn = document.getElementById('medium-btn'); const hardBtn = document.getElementById('hard-btn'); const topProgressBar = document.getElementById('top-progress-bar'); const p1TimerEl = document.getElementById('p1-timer'); const p1TimerValueEl = document.getElementById('p1-timer-value');

        // Oyun Değişkenleri
        let audioCtx; let gameMode = null; let gameSettings = { words: 10, difficulty: null, timerDuration: 0 }; let state = {}; let introCountdownInterval = null; let gameTimerInterval = null; let totalTimeLeft = 0;

        // --- Yardımcı Fonksiyonlar ---
        function initAudio() { /* ... */ }
        function playCorrectSound() { console.log("Ses: Doğru"); }
        function playIncorrectSound() { console.log("Ses: Yanlış"); }

        function showScorePopup(player, points) { if (points <= 0) return; const playerScreen = players[player].el; if (!playerScreen) return; const popup = document.createElement('div'); popup.className = 'score-popup'; popup.textContent = `+${points}`; playerScreen.appendChild(popup); setTimeout(() => { if (popup.parentNode === playerScreen) { playerScreen.removeChild(popup); } }, 1150); }
        function triggerConfetti(winnerPlayer) { /* ... */ }

        function animateLetterFly(player, optionEl) { if (!optionEl || !optionEl.firstElementChild) return; const playerScreen = players[player].el; if (!playerScreen) return; const letterSpan = optionEl.firstElementChild; const letter = letterSpan.textContent; const rect = optionEl.getBoundingClientRect(); const playerRect = playerScreen.getBoundingClientRect(); const flyingChar = document.createElement('span'); flyingChar.className = 'flying-char'; flyingChar.textContent = letter; flyingChar.lang = 'ar'; const startX = rect.left + rect.width / 2 - playerRect.left; const startY = rect.top + rect.height / 2 - playerRect.top; flyingChar.style.left = `${startX}px`; flyingChar.style.top = `${startY}px`; playerScreen.appendChild(flyingChar); requestAnimationFrame(() => { flyingChar.style.transform = `translate(-50%, -150px) scale(0.8)`; flyingChar.style.opacity = '0'; }); setTimeout(() => { if (flyingChar.parentNode === playerScreen) { playerScreen.removeChild(flyingChar); } }, 600); }

        // GENERATEMASTERQUESTIONSET GÜNCELLENDİ (Kelime sayısı ayarlama mantığı)
        function generateMasterQuestionSet(availableWords, targetNumQuestions) {
            console.log(`Generating questions for target: ${targetNumQuestions}`);
            const allLetters = Object.keys(availableWords).filter(l => availableWords[l] && availableWords[l].length > 0 && letterForms[l]);
            let allWordsList = [];
            allLetters.forEach(l => {
                if(availableWords[l]){
                    availableWords[l].forEach(ow => {
                         const cleanOriginal = removeHarakat(ow);
                         if (cleanOriginal.includes(l)) {
                             allWordsList.push({ letter: l, originalWord: ow });
                         } else {
                              // console.warn(`Word "${ow}" doesn't contain key letter "${l}", skipping.`);
                         }
                    });
                }
            });
            allWordsList = shuffle(allWordsList);

             // Mevcut kelime sayısını kontrol et
             let actualWordCount = allWordsList.length;
             let numQuestionsToGenerate = Math.min(targetNumQuestions, actualWordCount); // İstenen veya mevcut olanın küçüğü kadar üret

            console.log(`Available unique words for generation: ${actualWordCount}, generating: ${numQuestionsToGenerate}`);

            // Eğer üretilecek soru sayısı hedeften az ise, oyun ayarını GÜNCELLE
             if (numQuestionsToGenerate < gameSettings.words) {
                 console.warn(`Insufficient words (${actualWordCount}) for target ${gameSettings.words}. Setting game words to ${numQuestionsToGenerate}.`);
                 gameSettings.words = numQuestionsToGenerate;
             }


            const selectedWords = allWordsList.slice(0, numQuestionsToGenerate);

            const questions = selectedWords.map(item => {
                const { letter, originalWord } = item;
                const cleanWord = removeHarakat(originalWord);
                const cleanLetterIndex = cleanWord.indexOf(letter);

                if (cleanLetterIndex === -1) {
                    console.error(`Letter find ERROR: "${cleanWord}", "${letter}", OW:"${originalWord}"`);
                    return null;
                }

                const questionWord = cleanWord.substring(0, cleanLetterIndex) + 'ـ ـ ـ' + cleanWord.substring(cleanLetterIndex + 1);
                const correctForm = getCorrectForm(cleanWord, letter, cleanLetterIndex);
                const availableForms = letterForms[letter];

                if (!availableForms) {
                    console.error(`Form list ERROR: "${letter}"`);
                    return null;
                }
                if (!correctForm) {
                     console.error(`Correct form ERROR: "${cleanWord}", "${letter}", index ${cleanLetterIndex}`);
                     return null;
                 }

                let options = [correctForm];
                const incorrectForms = availableForms.filter(f => f !== correctForm);
                const shuffledIncorrect = shuffle(incorrectForms);

                for (let i = 0; i < shuffledIncorrect.length && options.length < 4; i++) {
                     // Seçeneğin zaten eklenmediğinden emin ol (nadiren de olsa aynı form birden fazla listede olabilir)
                     if (!options.includes(shuffledIncorrect[i])) {
                         options.push(shuffledIncorrect[i]);
                     }
                }

                let attempts = 0;
                 while(options.length < 2 && availableForms.length > 0 && attempts < 10) { // En az 2 seçenek olmalı
                     let potentialOption = availableForms[Math.floor(Math.random() * availableForms.length)];
                      if (!options.includes(potentialOption)) { // Sadece unik ise ekle
                          options.push(potentialOption);
                      }
                     // options = [...new Set(options)]; // Tekrarları kaldır (bu zaten yukarıdaki if ile sağlanıyor)
                     attempts++;
                 }
                  // Eğer hala 2 seçenek yoksa, bu soruyu geçersiz kılabiliriz
                  if (options.length < 2) {
                       console.warn(`Could not generate at least 2 options for "${cleanWord}", letter "${letter}". Skipping question.`);
                       return null;
                   }


                return { letter, originalWord, word: cleanWord, questionWord, correctForm, options: shuffle(options) };
            }).filter(q => q !== null); // Hatalı (null) soruları filtrele

            // Filtreleme SONRASI soru sayısı GÜNCEL kelime sayısından az ise, ayarı TEKRAR güncelle (çok nadir olmalı)
             if (questions.length < gameSettings.words) {
                 console.warn(`Post-filtering question count (${questions.length}) is less than current game words (${gameSettings.words}). Updating game words AGAIN.`);
                 gameSettings.words = questions.length;
             }

            console.log(`Final generated questions: ${questions.length}`);
            return questions;
        }

        // GETCORRECTFORM GÜNCELLENDİ (Daha sağlam fallback)
        function getCorrectForm(cleanWord, cleanLetter, cleanIndex) {
            const forms = letterForms[cleanLetter];
            if (!forms || forms.length === 0) {
                 console.error("getCorrectForm: Harf için form bulunamadı!", cleanLetter);
                 return cleanLetter;
            }
            if (forms.length === 1) return forms[0];

            const nonConnectingChars = ['ا', 'أ', 'د', 'ذ', 'ر', 'ز', 'و'];
            const connectsToRight = cleanIndex > 0 && !nonConnectingChars.includes(cleanWord[cleanIndex - 1]);
            const connectsToLeft = cleanIndex < cleanWord.length - 1 && !nonConnectingChars.includes(cleanLetter);

             let targetForm = null;

             if (nonConnectingChars.includes(cleanLetter)) {
                 if (connectsToRight && forms.length > 1) { // Ortada/Sonda sağa bitişik (ـا)
                     targetForm = forms.find(f => f.startsWith('ـ')) || forms[1]; // Genellikle 2. form
                 } else { // Başta/Tek başına (ا)
                     targetForm = forms.find(f => !f.startsWith('ـ')) || forms[0]; // Genellikle 1. form
                 }
             } else { // Bitişen harf
                 if (connectsToRight && connectsToLeft && forms.length > 1) { // Ortada (ـبـ)
                     targetForm = forms.find(f => f.startsWith('ـ') && f.endsWith('ـ')) || forms[1]; // Genellikle 2. form
                 } else if (connectsToRight && forms.length > 2) { // Sonda (ـب)
                     targetForm = forms.find(f => f.startsWith('ـ') && !f.endsWith('ـ')) || forms[2]; // Genellikle 3. form
                 } else if (connectsToLeft && forms.length > 0) { // Başta (بـ)
                     targetForm = forms.find(f => !f.startsWith('ـ') && f.endsWith('ـ')) || forms[0]; // Genellikle 1. form
                 } else if (forms.length > 3) { // Tek başına (ب)
                     targetForm = forms.find(f => !f.startsWith('ـ') && !f.endsWith('ـ')) || forms[3]; // Genellikle 4. form
                 } else { // Eğer 4 form yoksa, mevcutlara göre fallback
                      if (connectsToRight) targetForm = forms[forms.length-1]; // Sona en yakın
                      else targetForm = forms[0]; // Başa en yakın
                  }
             }


             if (!targetForm) {
                 console.warn(`getCorrectForm: Mantık form bulamadı! "${cleanWord}", "${cleanLetter}", index ${cleanIndex}. Fallback (ilk form veya harf) kullanılıyor.`);
                 targetForm = forms[0] || cleanLetter;
             }
             return targetForm;
        }


        function shuffle(array) { let currentIndex = array.length, randomIndex; while (currentIndex != 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; } return array; }
        function removeHarakat(text) { return text.replace(/[\u0617-\u061A\u064B-\u0652]/g, ""); }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.round(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function stopGameTimer() {
            if (gameTimerInterval) {
                clearInterval(gameTimerInterval);
                gameTimerInterval = null;
            }
        }

        function startGameTimer() {
            stopGameTimer();
            if (gameMode !== '1p' || gameSettings.timerDuration <= 0 || gameSettings.words <= 0) {
                if (p1TimerEl) p1TimerEl.classList.add('hidden');
                return;
            }

            totalTimeLeft = gameSettings.timerDuration * gameSettings.words;
            if(p1TimerValueEl) p1TimerValueEl.textContent = formatTime(totalTimeLeft);
            if(p1TimerValueEl) p1TimerValueEl.style.color = '';
            if(p1TimerEl) p1TimerEl.classList.remove('hidden');

            gameTimerInterval = setInterval(() => {
                totalTimeLeft--;
                if(p1TimerValueEl) p1TimerValueEl.textContent = formatTime(totalTimeLeft);

                if (totalTimeLeft <= 10 && totalTimeLeft > 0) {
                    if(p1TimerValueEl) p1TimerValueEl.style.color = '#dc3545';
                }

                if (totalTimeLeft <= 0) {
                    console.log("Oyun Süresi Doldu!");
                    stopGameTimer();
                    playIncorrectSound();
                    endRound('timeup');
                }
            }, 1000);
        }

        // SETUPNEWGAME GÜNCELLENDİ (Kelime sayısı ayarlama mantığı iyileştirildi)
        function setupNewGame() {
            console.log("setupNewGame:", gameMode);
             // Başlangıçta hedeflenen kelime sayısını ayarla
            let targetWordCount = (gameMode === '1p') ? 20 : 10;
            gameSettings.words = targetWordCount; // Ayarı başlangıçta güncelle
            console.log("Initial target words:", targetWordCount);

            if (gameMode === '1p' && p1TimerEl) {
                p1TimerEl.classList.remove('hidden');
                 if(p1TimerValueEl) p1TimerValueEl.textContent = formatTime(gameSettings.timerDuration * targetWordCount);
            } else if (p1TimerEl) {
                p1TimerEl.classList.add('hidden');
            }

            // --- Soru Setlerini Oluştur (generateMasterQuestionSet GEREKİRSE gameSettings.words'ü güncelleyecek) ---
            let availableWords1 = JSON.parse(JSON.stringify(wordsByLetterWithHarakat));
            const questions1 = generateMasterQuestionSet(availableWords1, targetWordCount);
            let currentWordCount = gameSettings.words; // Generate sonrası GÜNCEL kelime sayısı
             console.log("P1 Qs generated:", questions1.length, "Current game words:", currentWordCount);

             // Eğer 1P ve kelime sayısı düştüyse, zamanı hemen GÜNCELLE
             if (gameMode === '1p' && currentWordCount < targetWordCount) {
                 totalTimeLeft = gameSettings.timerDuration * currentWordCount;
                 if(p1TimerValueEl) p1TimerValueEl.textContent = formatTime(totalTimeLeft);
             }


            state = { scores: { '1': 0 }, currentRound: -1, playerQuestions: { '1': questions1 }, answers: { '1': [] } }; // answers'ı boş array yap
             if (gameMode === '2p') state.answers['2'] = []; // 2P için de

            players['1'].scoreEl.textContent = '0';
            players['1'].wordEl.textContent = "...";

            if (gameMode === '2p') {
                let availableWords2 = JSON.parse(JSON.stringify(wordsByLetterWithHarakat));
                // P2 için generate et (bu da gameSettings.words'ü güncelleyebilir)
                const questions2 = generateMasterQuestionSet(availableWords2, targetWordCount);
                currentWordCount = gameSettings.words; // P2 sonrası en güncel kelime sayısı
                console.log("P2 Qs generated:", questions2.length, "Final game words:", currentWordCount);

                // P1 ve P2 listelerini GÜNCEL kelime sayısına göre KISALT/AYARLA
                 state.playerQuestions['1'] = questions1.slice(0, currentWordCount);
                state.playerQuestions['2'] = questions2.slice(0, currentWordCount);


                state.scores['2'] = 0;
                // state.answers['2'] = []; // Yukarıda yapıldı
                state.playerResponses = { '1': null, '2': null };
                state.responseTimes = { '1': null, '2': null };
                players['2'].scoreEl.textContent = '0';
                players['2'].wordEl.textContent = "...";
            }

             // --- Progress Bar'ları GÜNCEL kelime sayısına göre kur ---
             setupProgressBars(); // Tüm generate işlemleri bittikten sonra çağır


            modal.style.display = 'none';
            if (gameSettings.words > 0) { // Her zaman GÜNCEL kelime sayısını kontrol et
                if (gameMode === '1p') {
                    startGameTimer(); // Timer'ı başlat (içeride güncel gameSettings.words'ü kullanır)
                }
                nextQuestion();
            } else {
                console.error("Başlatılacak soru yok!");
                alert("Yeterli kelime bulunamadı, ana menüye dönülüyor.");
                returnToMenu();
            }
        }
        function setupProgressBars() { const numQuestions = gameSettings.words; console.log("Setting up progress bars for", numQuestions, "words"); if (numQuestions <= 0) return; topProgressBar.innerHTML = ''; players['1'].progressEl.innerHTML = ''; players['2'].progressEl.innerHTML = ''; if (gameMode === '1p') { let columns = numQuestions > 10 ? Math.ceil(numQuestions / 2) : numQuestions; columns = Math.min(10, columns); let rows = numQuestions > 10 ? 2 : 1; topProgressBar.style.display = 'grid'; topProgressBar.style.gridTemplateRows = `repeat(${rows}, 1fr)`; topProgressBar.style.gridTemplateColumns = `repeat(${columns}, 1fr)`; for (let i = 0; i < numQuestions; i++) { const wordDiv = document.createElement('div'); wordDiv.classList.add('progress-word'); topProgressBar.appendChild(wordDiv); } } else { ['1', '2'].forEach(p => { players[p].progressEl.style.gridTemplateColumns = `repeat(${numQuestions}, 1fr)`; for (let i = 0; i < numQuestions; i++) { const wordDiv = document.createElement('div'); wordDiv.classList.add('progress-word'); players[p].progressEl.appendChild(wordDiv); } }); } }
        function displayQuestion(player, question) { if (!question || !question.questionWord || !question.options || question.options.length < 2) { console.error(`Geçersiz SORU veya SEÇENEK: P${player}, R${state.currentRound}`, question); endRound('error'); return; } if (!players[player] || !players[player].wordEl || !players[player].optionsEl) { console.error(`P${player} DOM elemanları yok!`); return; } players[player].wordEl.textContent = question.questionWord; players[player].optionsEl.innerHTML = ''; const shuffledOptions = shuffle([...question.options]); players[player].optionsEl.style.gridTemplateColumns = 'repeat(2, 1fr)'; shuffledOptions.forEach((opt) => { const optionDiv = document.createElement('div'); optionDiv.classList.add('option'); const charSpan = document.createElement('span'); charSpan.textContent = opt; optionDiv.appendChild(charSpan); optionDiv.onclick = (event) => handleAnswer(player, opt, question.correctForm, event.currentTarget); players[player].optionsEl.appendChild(optionDiv); }); }

        function handleAnswer(player, selectedOption, correctOption, clickedEl) {
            if (gameMode === '2p' && state.playerResponses[player] !== null) return;
             // 1P modunda, mevcut tur için ZATEN cevap verilmişse tekrar işlem yapma
             if (gameMode === '1p' && state.answers['1'][state.currentRound] !== undefined) {
                 console.log(`Round ${state.currentRound} already answered for P1.`);
                 return;
             }


            initAudio();
            if (state.currentRound < 0 || state.currentRound >= gameSettings.words) {
                 console.warn(`handleAnswer called for invalid round: ${state.currentRound}`);
                 return;
            }
            const currentQuestion = state.playerQuestions[player] ? state.playerQuestions[player][state.currentRound] : null;
            if (!currentQuestion) { console.error("handleAnswer: Soru yok!"); return; }

            if (correctOption === null || correctOption === undefined) {
                 console.error("handleAnswer: CorrectOption tanımsız!", currentQuestion);
                 highlightOptions(player, selectedOption, null);
                 setTimeout(nextQuestion, 1500);
                 return;
             }

            const isCorrect = selectedOption === correctOption;
            const playerScreen = players[player].el;
            if (!playerScreen) return;

            if (isCorrect) {
                playCorrectSound();
                playerScreen.classList.add('flash-correct');
                animateLetterFly(player, clickedEl);
                if(players[player].wordEl) {
                    setTimeout(() => { if(players[player].wordEl) players[player].wordEl.textContent = currentQuestion.word; }, 500);
                }
                setTimeout(() => playerScreen.classList.remove('flash-correct'), 600);
            } else {
                playIncorrectSound();
                playerScreen.classList.add('incorrect-answer-effect');
                setTimeout(() => playerScreen.classList.remove('incorrect-answer-effect'), 600);
            }

            highlightOptions(player, selectedOption, correctOption);

            if (gameMode === '1p') {
                state.answers['1'][state.currentRound] = { word: currentQuestion.word, correct: isCorrect };

                let p1Points = 0;
                if (isCorrect) { p1Points = 5; showScorePopup('1', p1Points); }
                state.scores['1'] += p1Points;
                players['1'].scoreEl.textContent = state.scores['1'];

                const progressWords = topProgressBar.children;
                 // Progress bar index kontrolü
                if (state.currentRound >= 0 && state.currentRound < progressWords.length) {
                    progressWords[state.currentRound].classList.add(isCorrect ? 'correct' : 'incorrect');
                } else {
                     console.warn("1P Progress bar item index out of bounds:", state.currentRound, "length:", progressWords.length);
                 }
                setTimeout(nextQuestion, 1500);
            } else { // 2P Modu
                state.playerResponses[player] = selectedOption;
                state.responseTimes[player] = new Date().getTime();
                 // Cevabı state'e ekle (index kullanarak) - ÖNEMLİ: state.answers[player] array olmalı
                 if (!state.answers[player]) state.answers[player] = []; // Eğer array yoksa oluştur
                 state.answers[player][state.currentRound] = { word: currentQuestion.word, correct: isCorrect, time: state.responseTimes[player] };

                const otherPlayer = player === '1' ? '2' : '1';
                // Diğer oyuncu ZATEN cevap verdiyse VEYA diğer oyuncunun bu turda sorusu yoksa (hata durumu)
                 if (state.playerResponses[otherPlayer] !== null || !state.playerQuestions[otherPlayer] || !state.playerQuestions[otherPlayer][state.currentRound]) {
                     // Eğer diğer oyuncu cevap vermişse skorları güncelle ve sonraki soruya geç
                     if (state.playerResponses[otherPlayer] !== null) {
                         updateScores();
                         setTimeout(nextQuestion, 2000);
                     } else {
                          // Diğer oyuncunun sorusu yoksa, sadece sonraki soruya geçmeyi dene (hata durumu)
                          console.warn(`Other player (${otherPlayer}) has no question for round ${state.currentRound}. Proceeding.`);
                          setTimeout(nextQuestion, 2000);
                      }
                }
                 // Eğer diğer oyuncu henüz cevap vermemişse, sadece bekle.
            }
        }


        function highlightOptions(player, selected, correct) { const optionsContainer = players[player].optionsEl; if (!optionsContainer) return; const options = optionsContainer.children; for (let opt of options) { opt.classList.add('disabled'); if (opt.firstElementChild) { const optionText = opt.firstElementChild.textContent; if (optionText === correct) { opt.classList.add('correct'); } else if (optionText === selected && correct !== null) { opt.classList.add('incorrect'); } } } }

        function updateScores() {
             if (state.currentRound < 0 || state.currentRound >= gameSettings.words) { console.warn("updateScores geçersiz tur:", state.currentRound); return; }
             const p1Q = state.playerQuestions['1'][state.currentRound];
             const p2Q = state.playerQuestions['2'][state.currentRound];
             if (!p1Q || !p2Q) { console.error("updateScores: Soru nesneleri bulunamadı!", state.currentRound); return; }

             // Cevapların varlığını kontrol et, yoksa false kabul et
             const p1Response = state.playerResponses['1'];
             const p2Response = state.playerResponses['2'];
             const p1Correct = p1Response !== null && p1Response === p1Q.correctForm;
             const p2Correct = p2Response !== null && p2Response === p2Q.correctForm;

             let p1Pts = 0; let p2Pts = 0;
             const t1 = state.responseTimes['1']; // null olabilir
             const t2 = state.responseTimes['2']; // null olabilir

             if (p1Correct && p2Correct) { // İkisi de doğruysa
                 // Zamanları karşılaştır (null kontrolü ile)
                 if (t1 !== null && (t2 === null || t1 < t2)) { p1Pts = 10; p2Pts = 5; } // P1 daha hızlı veya P2 cevaplamadı
                 else if (t2 !== null && (t1 === null || t2 < t1)) { p1Pts = 5; p2Pts = 10; } // P2 daha hızlı veya P1 cevaplamadı
                 else { p1Pts = 5; p2Pts = 5; } // Eşit süre veya ikisi de null (teorik olarak olmamalı)
             } else if (p1Correct && !p2Correct) { // Sadece P1 doğruysa
                 p1Pts = 10; p2Pts = 0;
             } else if (!p1Correct && p2Correct) { // Sadece P2 doğruysa
                 p1Pts = 0; p2Pts = 10;
             } // İkisi de yanlış veya cevaplamadıysa 0 puan

             showScorePopup('1', p1Pts); showScorePopup('2', p2Pts);
             state.scores['1'] += p1Pts; state.scores['2'] += p2Pts;
             players['1'].scoreEl.textContent = state.scores['1'];
             players['2'].scoreEl.textContent = state.scores['2'];

             const p1Prg = players['1'].progressEl?.children;
             if (p1Prg && state.currentRound < p1Prg.length) {
                 p1Prg[state.currentRound].classList.add(p1Correct ? 'correct' : 'incorrect');
             } else { console.warn("P1 Progress bar item index out of bounds:", state.currentRound); }
             const p2Prg = players['2'].progressEl?.children;
              if (p2Prg && state.currentRound < p2Prg.length) {
                 p2Prg[state.currentRound].classList.add(p2Correct ? 'correct' : 'incorrect');
              } else { console.warn("P2 Progress bar item index out of bounds:", state.currentRound); }
        }


        function nextQuestion() {
            state.currentRound++;
            console.log("Next Round:", state.currentRound + 1, "/", gameSettings.words);
            if (state.currentRound >= gameSettings.words) {
                console.log("Oyun Bitti");
                endRound('completed');
                return;
            }
            if (gameMode === '1p') {
                if (state.playerQuestions['1'] && state.playerQuestions['1'][state.currentRound]) {
                    displayQuestion('1', state.playerQuestions['1'][state.currentRound]);
                } else {
                    console.error(`1P Soru ${state.currentRound} yüklenemedi!`);
                    endRound('error');
                }
            } else { // 2P
                state.playerResponses = { '1': null, '2': null }; // Cevapları sıfırla
                state.responseTimes = { '1': null, '2': null }; // Zamanları sıfırla
                 // state.answers[player][state.currentRound] handleAnswer içinde ayarlanacak

                 let p1HasQuestion = state.playerQuestions['1'] && state.playerQuestions['1'][state.currentRound];
                 let p2HasQuestion = state.playerQuestions['2'] && state.playerQuestions['2'][state.currentRound];

                 if (p1HasQuestion && p2HasQuestion) { // İki oyuncu için de soru varsa
                     displayQuestion('1', state.playerQuestions['1'][state.currentRound]);
                     displayQuestion('2', state.playerQuestions['2'][state.currentRound]);
                 } else {
                      // Eğer herhangi bir oyuncu için soru yoksa, bu bir hata durumudur
                      console.error(`2P Soru yüklenemedi! P1:${!!p1HasQuestion}, P2:${!!p2HasQuestion} for round ${state.currentRound}`);
                      endRound('error');
                      return;
                  }
            }
            if (gameMode === '1p') {
                if (p1TimerValueEl) {
                    p1TimerValueEl.style.color = (totalTimeLeft <= 10 && totalTimeLeft > 0) ? '#dc3545' : '';
                }
            }
        }
        // ENDROUND GÜNCELLENDİ (Sonuç listesi mantığı)
        function endRound(reason) {
             console.log("endRound:", reason, "Total words:", gameSettings.words);
             stopGameTimer();
             modal.classList.add(gameMode === '1p' ? 'mode-1p' : 'mode-2p');
             modal.classList.remove(gameMode === '1p' ? 'mode-2p' : 'mode-1p');

             const totalQuestions = gameSettings.words;
             if (totalQuestions <= 0 && reason !== 'error') { // Hata durumu hariç kelime yoksa
                 winnerText.textContent = "Yeterli soru bulunamadı!";
                 if (players['1'].resultsEl) players['1'].resultsEl.innerHTML = '';
                 if (players['2'].resultsEl) players['2'].resultsEl.innerHTML = '';
                 document.getElementById('result-column-2').style.display = 'none';
                 modal.style.display = 'flex';
                 return;
             } else if (reason === 'error') {
                  winnerText.textContent = "Oyun Hatası!";
                  // Sonuçları temizle veya boş bırak
                  if (players['1'].resultsEl) players['1'].resultsEl.innerHTML = '';
                  if (players['2'].resultsEl) players['2'].resultsEl.innerHTML = '';
                   if(gameMode === '1p') document.getElementById('result-column-2').style.display = 'none';
                  modal.style.display = 'flex';
                  return;
              }


             const arabicNumerals = Array.from({length: totalQuestions}, (_, i) => (i + 1).toLocaleString('ar-EG'));

             const score1 = state.scores ? state.scores['1'] : 0;
             const p1Answers = state.answers['1'] || []; // Undefined ise boş array
             const numQuestionsAnswered1P = p1Answers.filter(a => a !== undefined && a !== null).length;


             if (players['1'].resultsEl) players['1'].resultsEl.innerHTML = ''; else console.error("P1 sonuç elemanı yok!");
             winnerText.lang = 'tr'; winnerText.dir = 'ltr';

             if (gameMode === '1p') {
                 const correctCount = p1Answers.filter(a => a && a.correct).length;

                 if (reason === 'timeup') { winnerText.textContent = `Süre Bitti! Skor: ${score1}`; }
                 else if (reason === 'completed') { winnerText.textContent = `Tebrikler! Skor: ${score1}`; }
                 else { winnerText.textContent = `Oyun Bitti! Skor: ${score1}`; }


                 const p1H3 = document.querySelector('#result-column-1 h3');
                 if (p1H3) { p1H3.textContent = 'Sonuçların'; p1H3.lang = 'tr'; p1H3.dir = 'ltr'; }

                 const scoreDiv1 = document.createElement('div');
                 scoreDiv1.className = 'flex items-center justify-center gap-2 text-3xl mb-2 w-full';
                 scoreDiv1.innerHTML = `<span class="text-4xl">⭐</span><span>${score1}</span>`;
                 players['1'].resultsEl.appendChild(scoreDiv1);

                 const countDiv = document.createElement('div');
                 countDiv.className = 'flex items-center justify-center gap-2 text-2xl mb-4 w-full text-gray-700';
                 countDiv.dir = 'ltr';
                 let countText = `✓ ${correctCount} / ${totalQuestions}`;
                 if (reason === 'timeup') countText = `✓ ${correctCount} / ${numQuestionsAnswered1P} (Toplam: ${totalQuestions})`;
                 countDiv.innerHTML = countText;
                 players['1'].resultsEl.appendChild(countDiv);

                 // Sonuç listesi
                 for(let i=0; i < totalQuestions; i++){
                      const ans1 = p1Answers[i]; // Undefined olabilir
                      const questionWord = (state.playerQuestions && state.playerQuestions['1'] && state.playerQuestions['1'][i]) ? state.playerQuestions['1'][i].word : '-';
                      const wordToShow = ans1 ? ans1.word : questionWord;
                      const isCorrect = ans1 ? ans1.correct : false;
                      const mark1 = ans1 ? (isCorrect ? '✓' : '✗') : '-';
                      const color = ans1 ? (isCorrect ? 'green' : 'red') : 'grey';

                      const div1 = document.createElement('div'); div1.classList.add('result-item');
                      div1.innerHTML = `<span lang="ar">${arabicNumerals[i]}</span><span lang="ar">${wordToShow}</span><span style="color: ${color};">${mark1}</span>`;
                      players['1'].resultsEl.appendChild(div1);
                  }

                 document.getElementById('result-column-2').style.display = 'none';
                 const grid1P = document.querySelector('#results-container .results-grid');
                 if (grid1P) grid1P.style.gridTemplateColumns = '1fr';

             } else { // 2P Mode
                 if (players['2'].resultsEl) players['2'].resultsEl.innerHTML = ''; else console.error("P2 sonuç elemanı yok!");
                 document.getElementById('result-column-2').style.display = 'block';

                 const p1H3 = document.querySelector('#result-column-1 h3');
                 if (p1H3) { p1H3.textContent = 'Oyuncu 2'; p1H3.lang = 'tr'; p1H3.dir = 'ltr'; }
                 const p2H3 = document.querySelector('#result-column-2 h3');
                 if (p2H3) { p2H3.textContent = 'Oyuncu 1'; p2H3.lang = 'tr'; p2H3.dir = 'ltr'; }

                 const score2 = state.scores ? state.scores['2'] : 0;
                 if (score1 > score2) { triggerConfetti('1'); winnerText.textContent = `Oyuncu 2 Kazandı!`; }
                 else if (score2 > score1) { triggerConfetti('2'); winnerText.textContent = `Oyuncu 1 Kazandı!`; }
                 else { winnerText.textContent = 'Berabere!'; }

                 const p2Answers = state.answers['2'] || []; // Undefined ise boş array

                 const scoreDiv1 = document.createElement('div');
                 scoreDiv1.className = 'flex items-center justify-center gap-2 text-3xl mb-4 w-full';
                 scoreDiv1.innerHTML = `<span class="text-4xl">⭐</span><span>${score1}</span>`;
                 players['1'].resultsEl.appendChild(scoreDiv1);

                 const scoreDiv2 = document.createElement('div');
                 scoreDiv2.className = 'flex items-center justify-center gap-2 text-3xl mb-4 w-full';
                 scoreDiv2.innerHTML = `<span class="text-4xl">⭐</span><span>${score2}</span>`;
                 players['2'].resultsEl.appendChild(scoreDiv2);

                 // Sonuç listesi
                 for(let i=0; i < totalQuestions; i++){
                     const ans1 = p1Answers[i]; const ans2 = p2Answers[i]; // Undefined olabilirler
                     const q1 = state.playerQuestions['1'][i]; const q2 = state.playerQuestions['2'][i];

                     const word1 = ans1 ? ans1.word : (q1 ? q1.word : '-');
                     const correct1 = ans1 ? ans1.correct : false;
                     const time1 = ans1 ? ans1.time : Infinity;

                     const word2 = ans2 ? ans2.word : (q2 ? q2.word : '-');
                     const correct2 = ans2 ? ans2.correct : false;
                     const time2 = ans2 ? ans2.time : Infinity;

                     let p1Speed = false; let p2Speed = false;
                     if (ans1 && ans2) { // İkisi de cevapladıysa
                          if (correct1 && correct2) { if (time1 < time2) p1Speed = true; else if (time2 < time1) p2Speed = true; } // Eşitse hız yok
                          else if (correct1 && !correct2) { p1Speed = true; }
                          else if (!correct1 && correct2) { p2Speed = true; }
                      } else if (ans1 && correct1) { p1Speed = true; } // Sadece P1 doğru
                       else if (ans2 && correct2) { p2Speed = true; } // Sadece P2 doğru

                     const icon = '⚡️';
                     const div1 = document.createElement('div'); div1.classList.add('result-item');
                     const mark1 = ans1 ? (correct1 ? '✓' : '✗') : '-';
                     const color1 = ans1 ? (correct1 ? 'green' : 'red') : 'grey';
                     div1.innerHTML = `<span lang="ar">${arabicNumerals[i]}</span><span lang="ar">${word1}</span><span style="color: ${color1};">${mark1}</span>${p1Speed ? `<span class="text-yellow-500">${icon}</span>` : ''}`;
                     players['1'].resultsEl.appendChild(div1);

                     const div2 = document.createElement('div'); div2.classList.add('result-item');
                     const mark2 = ans2 ? (correct2 ? '✓' : '✗') : '-';
                     const color2 = ans2 ? (correct2 ? 'green' : 'red') : 'grey';
                     div2.innerHTML = `<span lang="ar">${arabicNumerals[i]}</span><span lang="ar">${word2}</span><span style="color: ${color2};">${mark2}</span>${p2Speed ? `<span class="text-yellow-500">${icon}</span>` : ''}`;
                     if (players['2'].resultsEl) players['2'].resultsEl.appendChild(div2);
                 }
             }
             resultsWrapper.style.display = 'block';
             modal.style.display = 'flex';
        }


        function startIntroCountdown(callback) { console.log("Intro Countdown"); if (introCountdownInterval) clearInterval(introCountdownInterval); const nums = { '3': '٣', '2': '٢', '1': '١' }; let count = 3; countdownOverlay.classList.remove('hidden'); countdownNumber.textContent = nums[count]; introCountdownInterval = setInterval(() => { count--; if (count > 0) { countdownNumber.textContent = nums[count]; } else { clearInterval(introCountdownInterval); introCountdownInterval = null; countdownOverlay.classList.add('hidden'); if(callback) { callback(); } } }, 1000); }

        function start1PGame(difficulty) {
            console.log("start1PGame:", difficulty);
            let timerDuration = 0;
            if (difficulty === 'easy') { timerDuration = 6; }
            else if (difficulty === 'medium') { timerDuration = 4.5; }
            else if (difficulty === 'hard') { timerDuration = 3; }

            gameSettings.difficulty = difficulty;
            gameSettings.timerDuration = timerDuration;
            // gameSettings.words setupNewGame içinde 20 olarak ayarlanacak

            document.body.classList.remove('mode-2p');
            document.body.classList.add('mode-1p');
            difficultyScreen.classList.add('hidden');
            gameWrapper.classList.remove('hidden');
            setupNewGame();
        }

        function returnToMenu() {
            console.log("returnToMenu");
            if (introCountdownInterval) { clearInterval(introCountdownInterval); introCountdownInterval = null; countdownOverlay.classList.add('hidden'); }
            stopGameTimer();
            state = {}; gameSettings = { words: 10, difficulty: null, timerDuration: 0 }; // Ayarları sıfırla
            modal.style.display = 'none';
            gameWrapper.classList.add('hidden');
            difficultyScreen.classList.add('hidden');
            rulesScreen.classList.remove('hidden');
            if (players['1'].wordEl) players['1'].wordEl.textContent = "...";
            if (players['2'].wordEl) players['2'].wordEl.textContent = "...";
            document.body.classList.remove('mode-1p', 'mode-2p');
            gameMode = null;
        }

        function returnToDifficultyScreen() {
            console.log("returnToDifficultyScreen");
            stopGameTimer();
            state = {}; // gameSettings'i SIFIRLAMA, difficulty ve timerDuration kalsın
            modal.style.display = 'none';
            gameWrapper.classList.add('hidden');
            difficultyScreen.classList.remove('hidden');
            rulesScreen.classList.add('hidden');
            if (players['1'].wordEl) players['1'].wordEl.textContent = "...";
            // Mod zaten '1p' olmalı
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM Loaded");

             if(backBtn) {
                 backBtn.onclick = () => {
                      // Geri butonuna basıldığında GÖRÜNEN ekrana göre karar ver
                      if (!rulesScreen.classList.contains('hidden')) {
                           // Ana menüdeyse bir şey yapma (veya uygulamadan çık?)
                           console.log("Back button pressed on main menu.");
                       } else if (!difficultyScreen.classList.contains('hidden')) {
                           // Zorluk ekranındaysa ana menüye dön
                           returnToMenu();
                       } else if (!gameWrapper.classList.contains('hidden')) {
                           // Oyun ekranındaysa
                           if (gameMode === '1p') {
                               returnToDifficultyScreen(); // 1P ise zorluk seçimine dön
                           } else {
                               returnToMenu(); // 2P ise ana menüye dön
                           }
                       } else if (modal.style.display === 'flex') {
                            // Modal açıksa (oyun bittiyse), hangi modda bittiğine göre dön
                            if (gameMode === '1p') {
                                returnToDifficultyScreen();
                            } else {
                                returnToMenu();
                            }
                       }
                       else { // Diğer durumlar için ana menüye dön (güvenlik)
                           returnToMenu();
                       }
                 };
             } else { console.error("backBtn yok!"); }


             if (start1PBtn) {
                 start1PBtn.onclick = () => {
                     console.log("1P clicked");
                     gameMode = '1p';
                     document.body.classList.remove('mode-2p');
                     document.body.classList.add('mode-1p');
                     rulesScreen.classList.add('hidden');
                     difficultyScreen.classList.remove('hidden');
                 };
             } else { console.error("start1PBtn yok!"); }
             if (start2PBtn) {
                 start2PBtn.onclick = () => {
                     console.log("2P clicked");
                     gameMode = '2p';
                      // gameSettings setupNewGame içinde ayarlanacak
                     gameSettings.difficulty = null;
                     gameSettings.timerDuration = 0;
                     document.body.classList.remove('mode-1p');
                     document.body.classList.add('mode-2p');
                     rulesScreen.classList.add('hidden');
                     gameWrapper.classList.remove('hidden');
                     startIntroCountdown(setupNewGame);
                };
             } else { console.error("start2PBtn yok!"); }

             if (easyBtn) easyBtn.onclick = () => start1PGame('easy'); else console.error("easyBtn yok!");
             if (mediumBtn) mediumBtn.onclick = () => start1PGame('medium'); else console.error("mediumBtn yok!");
             if (hardBtn) hardBtn.onclick = () => start1PGame('hard'); else console.error("hardBtn yok!");
        });
    </script>

    <script> /* Viewport Height Fix */ (function(){ function setAppHeight(){ document.documentElement.style.setProperty('--appH', window.innerHeight + 'px'); } setAppHeight(); window.addEventListener('resize', setAppHeight, { passive: true }); window.addEventListener('orientationchange', setAppHeight); })(); </script>
    <script id="mobile-boot-v2"> /* Mobile Boot Optimizations */ (function(){ function setVhUnit(){ const vh = window.visualViewport ? window.visualViewport.height * 0.01 : window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); } setVhUnit(); window.addEventListener('resize', setVhUnit); window.addEventListener('orientationchange', setVhUnit); function primeAudioOnce(){ try{ if (window.AudioContext || window.webkitAudioContext){ if (!window.__audioCtx) { window.__audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if (window.__audioCtx.state === 'suspended') { window.__audioCtx.resume && window.__audioCtx.resume(); } } }catch(e){} window.removeEventListener('touchstart', primeAudioOnce, {passive:true}); window.removeEventListener('click', primeAudioOnce, {passive:true}); } window.addEventListener('touchstart', primeAudioOnce, {passive:true, once:true}); window.addEventListener('click', primeAudioOnce, {passive:true, once:true}); const modal = document.getElementById('modal'); const rules = document.getElementById('rules-screen'); const difficulty = document.getElementById('difficulty-screen'); [modal, rules, difficulty].forEach(el=>{ if(!el) return; el.style.maxHeight = 'calc(var(--vh, 1vh) * 100)'; el.style.overflowY = 'auto'; }); })(); </script>

</body>
</html>