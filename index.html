<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Doğru Harfi Seç</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Harmattan:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            overflow: hidden; padding: 1rem; padding-top: 1rem;
            background-image: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            background-attachment: fixed; background-size: 200% 200%;
            animation: background-pan 15s ease infinite; overscroll-behavior-y: contain;
        }
        @keyframes background-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        [lang="ar"], .word, .option span { font-family: 'Arakom', 'Harmattan', system-ui, sans-serif; direction: rtl; }
        body, button, h1, h2, h3, p, div:not([lang="ar"]) { direction: ltr; }
        #back-btn { 
            position: fixed; top: 1rem; left: 1rem; z-index: 3000; width: 48px; height: 48px; 
            background-color: rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); 
            border-radius: 50%; display: flex; /* HER ZAMAN GÖRÜNÜR */
            align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease-in-out; 
            border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        #back-btn svg { width: 24px; height: 24px; }
        #top-progress-bar { display: none; width: 100%; max-width: 800px; margin: 0 auto 1rem auto; grid-template-columns: repeat(10, 1fr); gap: 4px; padding: 0 0.5rem; }
        .progress-word { height: 8px; background-color: rgba(255, 255, 255, 0.4); border-radius: 4px; transition: background-color 0.3s ease; }
        .progress-word.correct { background-color: #28a745; } .progress-word.incorrect { background-color: #dc3545; }
        .player-screen { display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; border-radius: 1.5rem; position: relative; overflow: hidden; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2); }
        #player-1 { background-color: rgba(227, 242, 253, 0.5); } #player-2 { background-color: rgba(255, 243, 224, 0.5); }
        body.mode-1p #player-2 { display: none; } body.mode-1p #player-1 { width: 100%; max-width: 800px; margin: 0 auto; } body.mode-1p #game-wrapper { justify-content: center; } body.mode-1p #player-1 .player-icon-wrapper { display: none; } body.mode-1p #top-progress-bar { display: grid; order: -1; } body.mode-1p #player-1 #progress-1 { display: none; } body.mode-1p #player-2 #progress-2 { display: none; } body.mode-1p .player-screen { 
            /* height: calc(100vh - 1rem); */ /* Bu satırı silin veya yorum yapın */
            min-height: calc(100vh - 1rem); /* Minimum yüksekliği koruyalım */
            overflow-y: auto; /* Gerekirse player-screen'in kendisi kaysın */
            justify-content: space-between; /* İçeriği ittirmek yerine aralıklı dağıt */
        } body.mode-1p #player-1 .status-bar { justify-content: flex-end; } body.mode-1p #p1-timer { display: flex; margin-right: auto; } #modal.mode-1p #result-column-2 { display: none; } #modal.mode-1p .results-grid { grid-template-columns: 1fr; max-width: 400px; margin-left: auto; margin-right: auto; }
        body.mode-2p #player-1, body.mode-2p #player-2 { width: 50%; } #modal.mode-2p .results-grid { grid-template-columns: 1fr; } /* Varsayılan 1 sütun */ body.mode-2p #top-progress-bar { display: none; } body.mode-2p #progress-1, body.mode-2p #progress-2 { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; width: 100%; max-width: 300px; margin: 0.5rem auto 1rem auto; order: -1; } body.mode-2p .progress-word { height: 8px; border-radius: 4px; } body.mode-2p .player-screen { height: calc(100vh - 2rem); } body.mode-2p .status-bar { justify-content: flex-end; }
        
        /* DÜZELTME BURADA */
        .question-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 1rem; order: 0; overflow-y: auto; }

        .word { font-size: clamp(3rem, 10vw, 5rem); color: #1f2937; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); font-weight: 700; }
        .options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; width: 100%; max-width: 400px; }
        .option { background-color: #ffffff; border: 1px solid rgba(0, 0, 0, 0.05); color: #1f2937; border-radius: 1rem; padding: 1rem; text-align: center; font-size: clamp(2rem, 8vw, 3rem); cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.08); } .option:hover { background-color: #f8f9fa; transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,0,0,0.12); } .option:active { transform: scale(0.98); transition-duration: 0.1s; } .option.correct { background-color: #d4edda; border-color: #28a745; } .option.incorrect { background-color: #f8d7da; border-color: #dc3545; } .option.disabled { pointer-events: none; opacity: 0.7; } .option span { color: #111827; font-weight: 700; }
        .status-bar { display: flex; align-items: center; width: 100%; padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.25); border-top: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1rem; font-size: 1.25rem; position: relative; }
        #modal { position: fixed; inset: 0; z-index: 1000; overflow-y: auto; padding: 1rem; display: none; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); } .modal-content { background-color: white; padding: 2rem; border-radius: 1.5rem; text-align: center; width: 95%; max-width: 800px; position: relative; margin: auto; max-height: 90vh; overflow-y: auto; } .results-grid { display: grid; gap: 1rem; margin-top: 1.5rem; } .result-column { padding: 1rem; border-radius: 1rem; position: relative; overflow: hidden; } 
        .result-item { font-size: 1.75rem; /* Büyütüldü */ font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .intro-screen { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; padding: 1rem; overflow-y: auto; } .info-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1.5rem; padding: 2rem; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2); }
        .difficulty-btn { padding: 0.8rem 2rem; font-size: 1.5rem; color: white; border-radius: 0.75rem; transition: all 0.2s; width: 100%; max-width: 384px; } .difficulty-btn.easy { background-color: #22c55e; } .difficulty-btn.easy:hover { background-color: #16a34a; } .difficulty-btn.medium { background-color: #f97316; } .difficulty-btn.medium:hover { background-color: #ea580c; } .difficulty-btn.hard { background-color: #ef4444; } .difficulty-btn.hard:hover { background-color: #dc2626; }
        .modal-secondary-btn { font-size: 1.25rem; font-weight: 600; padding: 0.75rem 1.5rem; background-color: #f3f4f6; color: #1f2937; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.2s ease; } .modal-secondary-btn:hover { background-color: #e5e7eb; }
        #countdown-overlay { font-size: clamp(8rem, 30vw, 15rem); color: white; font-weight: bold; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .player-screen.flash-correct { animation: flash-green 0.6s ease-out; } .player-screen.incorrect-answer-effect { animation: shake-and-flash-red 0.6s ease-out; } @keyframes flash-green { 0%, 100% { background-color: rgba(227, 242, 253, 0.5); } 50% { background-color: rgba(40, 167, 69, 0.5); } } #player-2.flash-correct { animation: flash-green-p2 0.6s ease-out; } @keyframes flash-green-p2 { 0%, 100% { background-color: rgba(255, 243, 224, 0.5); } 50% { background-color: rgba(40, 167, 69, 0.5); } } @keyframes shake-and-flash-red { 0% { transform: translateX(0); background-color: rgba(227, 242, 253, 0.5); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } 50% { background-color: rgba(220, 53, 69, 0.5); } 100% { transform: translateX(0); background-color: rgba(227, 242, 253, 0.5); } } #player-2.incorrect-answer-effect { animation: shake-and-flash-red-p2 0.6s ease-out; } @keyframes shake-and-flash-red-p2 { 0% { transform: translateX(0); background-color: rgba(255, 243, 224, 0.5); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } 50% { background-color: rgba(220, 53, 69, 0.5); } 100% { transform: translateX(0); background-color: rgba(255, 243, 224, 0.5); } }
        .flying-char { position: absolute; font-size: 3rem; font-weight: 700; color: #1f2937; opacity: 1; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.6s ease-out; z-index: 10; pointer-events: none; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .score-popup { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); font-size: 2.5rem; font-weight: bold; color: #ffc107; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); animation: score-anim 1.2s ease-out forwards; pointer-events: none; z-index: 20; } @keyframes score-anim { 0% { opacity: 1; transform: translate(-50%, 0) scale(0.8); } 50% { transform: translate(-50%, -40px) scale(1.1); } 100% { opacity: 0; transform: translate(-50%, -80px) scale(0.9); } }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: red; opacity: 0; animation: fall 4s linear infinite; } @keyframes fall { 0% { transform: translateY(-100vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; } }
        
        @media (min-width: 768px) {
            /* Tablet ve üstü için 2 sütunlu sonuç */
            #modal.mode-2p .results-grid { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 900px) { 
            body { padding: 0.5rem; padding-top: 0.5rem; } 
            #back-btn { top: 0.5rem; left: 0.5rem; width: 40px; height: 40px; } 
            #back-btn svg { width: 20px; height: 20px; } 
            #top-progress-bar { margin-bottom: 0.5rem; padding: 0 0.5rem; gap: 3px; } 
            .progress-word { height: 6px; border-radius: 3px; } 
            #game-wrapper{ flex-direction: column; gap: 0.5rem; } 
            .player-screen{ padding: 1rem; width: 100% !important; max-width: 100% !important; } 
            body.mode-2p .player-screen { height: calc(50vh - 1.5rem); } 
            
            /* MOBİL 1P YÜKSEKLİK KURALI DÜZELTİLDİ */
            body.mode-1p .player-screen { 
                height: calc(100vh - 1rem); 
                /* Bu kural hala 100vh'ye zorluyor, ancak içerdeki 
                   .question-container { overflow-y: auto; } 
                   kuralı sayesinde artık içerik taşarsa puan çubuğu kaybolmayacak. 
                */
            } 
            
            .question-container { gap: 0.75rem; } 
            .word { font-size: clamp(2.5rem, 8vw, 4rem); } 
            .options { gap: 0.75rem; } 
            .option { padding: 0.75rem; font-size: clamp(1.8rem, 7vw, 2.5rem); min-height: 52px;} 
            .status-bar { padding: 0.5rem 0.75rem; font-size: 1rem; } 
            body.mode-2p #progress-1, body.mode-2p #progress-2 { gap: 2px; max-width: 150px; margin: 0.5rem auto 0.75rem auto; } 
            body.mode-2p .progress-word { height: 5px; border-radius: 2.5px; } 
            .modal-content{ padding: 1.5rem; width: 95%; max-height: 85vh; } 
            .results-grid { margin-top: 1rem; } 
            .result-column { padding: 0.75rem; } 
            .result-item { font-size: 1.4rem; /* Büyütüldü (Mobil) */ gap: 0.5rem; } 
            #modal-buttons { flex-direction: column; align-items: center; } 
            .modal-secondary-btn { font-size: 1.1rem; width: 100%; max-width: 250px; } 
            h1 { font-size: 2.5rem !important; } 
            h2 { font-size: 1.8rem !important; } 
            h3 { font-size: 1.5rem !important; } 
            p { font-size: 1.1rem !important; } 
        }
        .player-icon-wrapper h1 { direction: ltr; } .result-column h3 { font-family: system-ui, sans-serif; } .result-item span:first-child { direction: rtl; } .result-item span:nth-child(2) { direction: rtl; }
    </style>
</head>
<body class="mode-2p">

    <div id="back-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </div>

    <div id="rules-screen" class="intro-screen">
        <div class="w-full max-w-xl mx-auto px-4 text-center">
            <div class="info-card">
                <h1 class="text-4xl md:text-5xl lg:text-7xl font-bold text-gray-800 mb-4" style="text-shadow: 0 2px 10px rgba(0,0,0,0.1);">Doğru Harfi Seç</h1>
                <p class="text-xl md:text-2xl lg:text-3xl text-gray-600 mt-4 mb-8 md:mb-12">Oyun Modunu Seçin</p>
                <div class="flex flex-col gap-4 md:gap-6 items-center">
                    <button id="start-1p-btn" class="group flex items-center justify-center gap-3 w-full max-w-sm px-6 py-4 bg-white/80 backdrop-blur-sm border border-white/50 rounded-xl shadow-lg transition-all duration-300 hover:bg-white hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500/70">
                        <svg class="w-8 h-8 text-blue-800 transition-transform duration-300 group-hover:scale-110" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a5 5 0 0 0-5 5a5 5 0 0 0 5 5a5 5 0 0 0 5-5a5 5 0 0 0-5-5M8 16c-1.6 0-3.08.38-4.32.97A7.32 7.32 0 0 0 12 21.5a7.32 7.32 0 0 0 8.32-4.53A13.06 13.06 0 0 0 16 16Z"></path></svg>
                        <span class="text-left"><span class="text-2xl md:text-3xl block font-semibold text-blue-900">1 Kişilik</span><span class="text-base md:text-lg block font-normal text-blue-800/80">Zamana Karşı Yarış</span></span>
                    </button>
                    <button id="start-2p-btn" class="group flex items-center justify-center gap-3 w-full max-w-sm px-6 py-4 bg-blue-700 rounded-xl shadow-lg transition-all duration-300 hover:bg-blue-800 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <svg class="w-8 h-8 text-white transition-transform duration-300 group-hover:scale-110" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13a3 3 0 0 0-3-3a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3m5.61.16A13.06 13.06 0 0 0 20 16c-1.6 0-3.08.38-4.32.97A7.32 7.32 0 0 0 12 21.5a7.32 7.32 0 0 0 8.32-4.53A13.06 13.06 0 0 0 16 16c.64 0 1.25.07 1.84.16M12 4a5 5 0 0 0-5 5a5 5 0 0 0 5 5a5 5 0 0 0 5-5a5 5 0 0 0-5-5M8 16c-1.6 0-3.08.38-4.32.97A7.32 7.32 0 0 0 12 21.5a7.32 7.32 0 0 0 8.32-4.53A13.06 13.06 0 0 0 16 16c-1.6 0-3.08.38-4.32.97A7.32 7.32 0 0 0 4 16.97A13.06 13.06 0 0 0 2.39 13.16C2.14 13.41 2 13.7 2 14v4a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-4c0-.3-.14-.59-.39-.84Z"></path></svg>
                        <span class="text-left"><span class="text-2xl md:text-3xl block font-semibold text-white">2 Kişilik</span><span class="text-base md:text-lg block font-normal text-blue-100/90">Arkadaşınla Yarış</span></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="difficulty-screen" class="intro-screen hidden">
        <div class="w-full max-w-xl mx-auto px-4 text-center">
            <div class="info-card">
                <h1 class="text-4xl md:text-5xl lg:text-7xl font-bold text-gray-800 mb-4">Zorluk Seçin</h1>
                <p class="text-xl md:text-2xl lg:text-3xl text-gray-600 mt-4 mb-8 md:mb-12">20 Kelimeyi Tamamla</p>
                <div class="flex flex-col gap-4 md:gap-6 items-center">
                    <button id="easy-btn" class="difficulty-btn easy"><span class="text-2xl md:text-3xl block">Kolay</span></button>
                    <button id="medium-btn" class="difficulty-btn medium"><span class="text-2xl md:text-3xl block">Orta</span></button>
                    <button id="hard-btn" class="difficulty-btn hard"><span class="text-2xl md:text-3xl block">Zor</span></button>
                </div>
            </div>
        </div>
    </div>

    <div id="countdown-overlay" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 hidden"><span id="countdown-number"></span></div>

    <div id="game-wrapper" class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 rtl:space-x-reverse hidden">
        <div id="player-2" class="w-full md:w-1/2 player-screen">
            <div class="w-full flex justify-center player-icon-wrapper">
                <div class="flex items-center gap-2 md:gap-3"> <svg class="w-8 h-8 md:w-10 lg:w-12" style="fill: #c57d00;" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.84,8c18.84-32.56,52.14-52,89.08-52s70.24,19.44,89.08,52a8,8,0,1,0,13.84-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg><h1 class="text-3xl md:text-4xl lg:text-5xl font-bold" style="color: #c57d00;">١</h1></div>
            </div>
            <div id="progress-2"></div>
            <div class="question-container"><div id="word-2" class="word" lang="ar">...</div><div id="options-2" class="options" lang="ar"></div></div>
            <div class="status-bar"><div class="flex items-center gap-1 md:gap-2 text-xl md:text-2xl"><span class="text-2xl md:text-3xl">⭐</span><span id="score-2">0</span></div></div>
        </div>
        <div id="player-1" class="w-full md:w-1/2 player-screen">
            <div class="w-full flex justify-center player-icon-wrapper">
                <div class="flex items-center gap-2 md:gap-3"> <svg class="w-8 h-8 md:w-10 lg:w-12" style="fill: #005f9e;" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.84,8c18.84-32.56,52.14-52,89.08-52s70.24,19.44,89.08,52a8,8,0,1,0,13.84-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg><h1 class="text-3xl md:text-4xl lg:text-5xl font-bold" style="color: #005f9e;">٢</h1></div>
            </div>
            <div id="top-progress-bar"></div><div id="progress-1"></div>
            <div class="question-container"><div id="word-1" class="word" lang="ar">...</div><div id="options-1" class="options" lang="ar"></div></div>
            <div class="status-bar"><div id="p1-timer" class="hidden items-center gap-1 md:gap-2 text-xl md:text-2xl"><span class="text-2xl md:text-3xl">⏱️</span><span id="p1-timer-value"></span></div><div class="flex items-center gap-1 md:gap-2 text-xl md:text-2xl"><span class="text-2xl md:text-3xl">⭐</span><span id="score-1">0</span></div></div>
        </div>
    </div>

    <div id="modal" class="items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-60" style="backdrop-filter: blur(4px);"></div>
        <div class="modal-content relative">
            <div id="results-wrapper">
                <h2 id="winner-text" class="text-2xl md:text-3xl font-bold mb-4"></h2> <div id="results-container">
                    <div class="results-grid">
                        <div id="result-column-2" class="result-column" style="background-color: #fff3e0;"><h3 class="text-xl md:text-2xl lg:text-3xl font-bold mb-3 text-center" lang="ar">الطّالِب ١</h3><div id="player-2-results" class="flex flex-col items-start" lang="ar"></div></div>
                        <div id="result-column-1" class="result-column" style="background-color: #e3f2fd;"><h3 class="text-xl md:text-2xl lg:text-3xl font-bold mb-3 text-center" lang="ar">الطّالِب ٢</h3><div id="player-1-results" class="flex flex-col items-start" lang="ar"></div></div>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <script>
        // Test verileri (Türkçe karakterler düzeltildi)
        const wordsByLetterWithHarakat = { 'ب': ['بَيْت', 'كِتَاب', 'بَاب', 'جَبَل', 'خُبْز'], 'ت': ['تُفَاح', 'مَكْتَب', 'بِنْت', 'تَمْر', 'مِفْتَاح'], 'ث': ['ثَوْب', 'مُثَلَّث', 'ثَلَاثَة', 'ثَعْلَب', 'أَثَاث'], 'ج': ['جَمَل', 'دَجَاجَة', 'شَجَرَة', 'مَسْjِد', 'ثَلْج'], 'ح': ['حَقِيبَة', 'مِفْتَاح', 'تِمْسَاح', 'مَلِح', 'لَوْح'], 'خ': ['خَرُوف', 'نَخْلَة', 'مَطْبَخ', 'خَوْخ', 'بَطِّيخ'], 'د': ['d_words'], 'ذ': ['ذُرَة', 'أُذُن', 'تِلْمِيذ', 'قُنْfُذ', 'ذَهَب'], 'ر': ['رَأْس', 'كُرْسِيّ', 'قَمَر', 'نَهْر', 'أَرْنَب'], 'ز': ['زَرَافَة', 'مِيزَان', 'خُبْز', 'مَوْز', 'جَزَر'], 'س': ['سَمَكَة', 'شَمْس', 'كُرْسِيّ', 'مَدْرَسَة', 'فَرَس'], 'ش': ['شَجَرَة', 'شَمْس', 'عُشّ', 'فَرَاشَة', 'مِشْمِش'], 'ص': ['صُورَة', 'قَمِيص', 'بَصَل', 'مِقَصّ', 'صَقْر'], 'ض': ['ضَابِط', 'مَرِيض', 'أَبْيَض', 'بَيْضَة', 'أَرْض'] };
        const letterForms = { 'ب': ['بـ', 'ـبـ', 'ـب', 'ب'], 'ت': ['تـ', 'ـتـ', 'ـت', 'ت'], 'ث': ['ثـ', 'ـثـ', 'ـث', 'ث'], 'ج': ['جـ', 'ـجـ', 'ـج', 'ج'], 'ح': ['حـ', 'ـحـ', 'ـح', 'ح'], 'خ': ['خـ', 'ـخـ', 'ـخ', 'خ'], 'د': ['د', 'ـد'], 'ذ': ['ذ', 'ـذ'], 'ر': ['ر', 'ـر'], 'ز': ['ز', 'ـز'], 'س': ['سـ', 'ـسـ', 'ـس', 'س'], 'ش': ['شـ', 'ـشـ', 'ـش', 'ش'], 'ص': ['صـ', 'ـصـ', 'ـص', 'ص'], 'ض': ['ضـ', 'ـضـ', 'ـض', 'ض'], 'ا': ['ا', 'ـا'], 'أ': ['أ', 'ـأ'], 'و': ['و', 'ـو'] };

        // DOM Elementleri
        const players = { '1': { el: document.getElementById('player-1'), wordEl: document.getElementById('word-1'), optionsEl: document.getElementById('options-1'), scoreEl: document.getElementById('score-1'), progressEl: document.getElementById('progress-1'), resultsEl: document.getElementById('player-1-results') }, '2': { el: document.getElementById('player-2'), wordEl: document.getElementById('word-2'), optionsEl: document.getElementById('options-2'), scoreEl: document.getElementById('score-2'), progressEl: document.getElementById('progress-2'), resultsEl: document.getElementById('player-2-results') } };
        const modal = document.getElementById('modal'); const winnerText = document.getElementById('winner-text'); const gameWrapper = document.getElementById('game-wrapper'); const rulesScreen = document.getElementById('rules-screen'); const start1PBtn = document.getElementById('start-1p-btn'); const start2PBtn = document.getElementById('start-2p-btn'); const countdownOverlay = document.getElementById('countdown-overlay'); const countdownNumber = document.getElementById('countdown-number'); const resultsWrapper = document.getElementById('results-wrapper'); const backBtn = document.getElementById('back-btn'); const difficultyScreen = document.getElementById('difficulty-screen'); const easyBtn = document.getElementById('easy-btn'); const mediumBtn = document.getElementById('medium-btn'); const hardBtn = document.getElementById('hard-btn'); const topProgressBar = document.getElementById('top-progress-bar'); const p1TimerEl = document.getElementById('p1-timer'); const p1TimerValueEl = document.getElementById('p1-timer-value');

        // Oyun Değişkenleri
        let audioCtx; let gameMode = '2p'; let gameSettings = { words: 10, difficulty: null, timerDuration: 0 }; let state = {}; let introCountdownInterval = null; let gameTimerInterval = null; let totalTimeLeft = 0;

        // --- Yardımcı Fonksiyonlar ---
        function initAudio() { /* ... */ }
        function playCorrectSound() { console.log("Ses: Doğru"); }
        function playIncorrectSound() { console.log("Ses: Yanlış"); }

        function showScorePopup(player, points) { if (points <= 0) return; const playerScreen = players[player].el; if (!playerScreen) return; const popup = document.createElement('div'); popup.className = 'score-popup'; popup.textContent = `+${points}`; playerScreen.appendChild(popup); setTimeout(() => { if (popup.parentNode === playerScreen) { playerScreen.removeChild(popup); } }, 1150); }
        function triggerConfetti(winnerPlayer) { /* ... */ }

        function animateLetterFly(player, optionEl) { if (!optionEl || !optionEl.firstElementChild) return; const playerScreen = players[player].el; if (!playerScreen) return; const letterSpan = optionEl.firstElementChild; const letter = letterSpan.textContent; const rect = optionEl.getBoundingClientRect(); const playerRect = playerScreen.getBoundingClientRect(); const flyingChar = document.createElement('span'); flyingChar.className = 'flying-char'; flyingChar.textContent = letter; flyingChar.lang = 'ar'; const startX = rect.left + rect.width / 2 - playerRect.left; const startY = rect.top + rect.height / 2 - playerRect.top; flyingChar.style.left = `${startX}px`; flyingChar.style.top = `${startY}px`; playerScreen.appendChild(flyingChar); requestAnimationFrame(() => { flyingChar.style.transform = `translate(-50%, -150px) scale(0.8)`; flyingChar.style.opacity = '0'; }); setTimeout(() => { if (flyingChar.parentNode === playerScreen) { playerScreen.removeChild(flyingChar); } }, 600); }

        function generateMasterQuestionSet(availableWords, numQuestions) { const allLetters = Object.keys(availableWords).filter(l=>availableWords[l]&&availableWords[l].length>0); let allWordsList = []; allLetters.forEach(l => { if(availableWords[l]){ availableWords[l].forEach(ow => { allWordsList.push({ letter: removeHarakat(l), originalWord: ow }); }); } }); allWordsList = shuffle(allWordsList); const selectedWords = allWordsList.slice(0, numQuestions); if (selectedWords.length < numQuestions) { console.warn(`Yetersiz kelime: ${numQuestions} vs ${selectedWords.length}`); } const questions = selectedWords.map(item => { const { letter, originalWord } = item; const cleanWord = removeHarakat(originalWord); const cleanLetterIndex = cleanWord.indexOf(letter); if (cleanLetterIndex === -1) { console.error(`Harf yok: "${cleanWord}", "${letter}", OW:"${originalWord}"`); return null; } const questionWord = cleanWord.substring(0, cleanLetterIndex) + 'ـ ـ ـ' + cleanWord.substring(cleanLetterIndex + 1); const correctForm = getCorrectForm(cleanWord, letter, cleanLetterIndex); const nonConnectingLetters = ['ا', 'أ', 'د', 'ذ', 'ر', 'ز', 'و']; let options; const availableForms = letterForms[letter]; if (!availableForms) { console.error(`Form yok: "${letter}"`); return null; } if (availableForms.length <= 2 || nonConnectingLetters.includes(letter)) { options = shuffle([...availableForms]); while (options.length < 2 && availableForms.length > options.length) { let formToAdd = availableForms.find(f => !options.includes(f)); if (formToAdd) options.push(formToAdd); else break; } } else { const incorrectForms = availableForms.filter(f => f !== correctForm); const numIncorrectNeeded = 3; const selectedIncorrect = shuffle(incorrectForms).slice(0, numIncorrectNeeded); options = shuffle([correctForm, ...selectedIncorrect]); while (options.length < 2 && availableForms.length > options.length) { let formToAdd = availableForms.find(f => !options.includes(f)); if (formToAdd) options.push(formToAdd); else break; } if (options.length > 4) { options.length = 4; if (!options.includes(correctForm)) { options[0] = correctForm; } options = shuffle(options); } } return { letter, originalWord, word: cleanWord, questionWord, correctForm, options }; }).filter(q => q !== null); if (questions.length < numQuestions) { console.warn(`Filtreleme: ${numQuestions} vs ${questions.length}`); } return questions; }
        function getCorrectForm(cleanWord, cleanLetter, cleanIndex) { const forms = letterForms[cleanLetter]; if (!forms) { console.error("getCorrectForm: Form yok!", cleanLetter); return cleanLetter; } const nonConnectingChars = ['ا', 'أ', 'د', 'ذ', 'ر', 'ز', 'و']; const connectsToRight = cleanIndex > 0 && !nonConnectingChars.includes(cleanWord[cleanIndex - 1]); const connectsToLeft = cleanIndex < cleanWord.length - 1 && !nonConnectingChars.includes(cleanLetter); let targetForm = cleanLetter; if (connectsToRight && connectsToLeft) { targetForm = forms.find(f => f.startsWith('ـ') && f.endsWith('ـ')) || forms[1] || targetForm; } else if (connectsToRight) { targetForm = forms.find(f => f.startsWith('ـ') && !f.endsWith('ـ')) || forms[2] || targetForm; } else if (connectsToLeft) { targetForm = forms.find(f => !f.startsWith('ـ') && f.endsWith('ـ')) || forms[0] || targetForm; } else { targetForm = forms.find(f => !f.startsWith('ـ') && !f.endsWith('ـ')) || forms[3] || targetForm; } if (nonConnectingChars.includes(cleanLetter)) { if (connectsToRight) { targetForm = forms.find(f => f.startsWith('ـ')) || forms[1] || targetForm; } else { targetForm = forms.find(f => !f.startsWith('ـ')) || forms[0] || targetForm; } } return targetForm; }
        function shuffle(array) { let currentIndex = array.length, randomIndex; while (currentIndex != 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; } return array; }
        function removeHarakat(text) { return text.replace(/[\u0617-\u061A\u064B-\u0652]/g, ""); }
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.round(seconds % 60); // Küsuratlı saniyeler için yuvarla
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function stopGameTimer() {
            if (gameTimerInterval) {
                clearInterval(gameTimerInterval);
                gameTimerInterval = null;
            }
        }

        function startGameTimer() {
            stopGameTimer(); // Varsa eski sayacı durdur
            if (gameMode !== '1p' || gameSettings.timerDuration <= 0) {
                if (p1TimerEl) p1TimerEl.classList.add('hidden');
                return; // 1P modunda değilsek veya süre ayarı yoksa başlatma
            }

            // Toplam süreyi hesapla (kelime sayısı * kelime başına saniye)
            totalTimeLeft = gameSettings.timerDuration * gameSettings.words;
            if(p1TimerValueEl) p1TimerValueEl.textContent = formatTime(totalTimeLeft);
            if(p1TimerValueEl) p1TimerValueEl.style.color = ''; // Rengi sıfırla
            if(p1TimerEl) p1TimerEl.classList.remove('hidden');

            gameTimerInterval = setInterval(() => {
                totalTimeLeft--;
                if(p1TimerValueEl) p1TimerValueEl.textContent = formatTime(totalTimeLeft);

                // Son 10 saniye kala rengi kırmızı yap
                if (totalTimeLeft <= 10 && totalTimeLeft > 0) {
                    if(p1TimerValueEl) p1TimerValueEl.style.color = '#dc3545';
                }

                // Süre biterse oyunu bitir
                if (totalTimeLeft <= 0) {
                    console.log("Oyun Süresi Doldu!");
                    stopGameTimer();
                    playIncorrectSound();
                    endRound('timeup'); // Oyunu "süre bitti" sebebiyle bitir
                }
            }, 1000);
        }

        function setupNewGame() { 
            console.log("setupNewGame:", gameMode, gameSettings); 
            const numQuestions = gameSettings.words; 
            if (gameMode === '1p' && p1TimerEl) { 
                p1TimerEl.classList.remove('hidden'); 
                if(p1TimerValueEl) p1TimerValueEl.textContent = formatTime(gameSettings.timerDuration * gameSettings.words); 
            } else if (p1TimerEl) { 
                p1TimerEl.classList.add('hidden'); 
            } 
            setupProgressBars(); 
            let availableWords1 = JSON.parse(JSON.stringify(wordsByLetterWithHarakat)); 
            const questions1 = generateMasterQuestionSet(availableWords1, numQuestions); 
            if (questions1.length < numQuestions) { 
                gameSettings.words = questions1.length; setupProgressBars(); 
            } 
            console.log("P1 Qs:", questions1.length); 
            state = { scores: { '1': 0 }, currentRound: -1, playerQuestions: { '1': questions1 }, answers: { '1': [] }, }; 
            players['1'].scoreEl.textContent = '0'; 
            players['1'].wordEl.textContent = "..."; 
            if (gameMode === '2p') { 
                let availableWords2 = JSON.parse(JSON.stringify(wordsByLetterWithHarakat)); 
                const questions2 = generateMasterQuestionSet(availableWords2, numQuestions); 
                if (questions2.length < numQuestions) { 
                    gameSettings.words = Math.min(questions1.length, questions2.length); 
                    console.log("Kelime sayısı güncellendi:", gameSettings.words); 
                    setupProgressBars(); 
                    state.playerQuestions['1'] = questions1.slice(0, gameSettings.words); 
                    state.playerQuestions['2'] = questions2.slice(0, gameSettings.words); 
                } else { 
                    state.playerQuestions['2'] = questions2; 
                } 
                console.log("P2 Qs:", state.playerQuestions['2']?.length); 
                state.scores['2'] = 0; 
                state.answers['2'] = []; 
                state.playerResponses = { '1': null, '2': null }; 
                state.responseTimes = { '1': null, '2': null }; 
                players['2'].scoreEl.textContent = '0'; 
                players['2'].wordEl.textContent = "..."; 
            } 
            modal.style.display = 'none'; 
            if (gameSettings.words > 0) {
                // Sadece 1 kişilik modda ve oyun kurulumunda toplam sayacı başlat
                if (gameMode === '1p') {
                    startGameTimer();
                }
                nextQuestion(); 
            } else { 
                console.error("Başlatılacak soru yok!"); 
                alert("Kelime listesi sorunu!"); 
                returnToMenu(); 
            } 
        }
        function setupProgressBars() { const numQuestions = gameSettings.words; topProgressBar.innerHTML = ''; players['1'].progressEl.innerHTML = ''; players['2'].progressEl.innerHTML = ''; if (gameMode === '1p') { let columns = numQuestions > 10 ? Math.ceil(numQuestions / 2) : numQuestions; columns = Math.min(10, columns); let rows = numQuestions > 10 ? 2 : 1; topProgressBar.style.display = 'grid'; topProgressBar.style.gridTemplateRows = `repeat(${rows}, 1fr)`; topProgressBar.style.gridTemplateColumns = `repeat(${columns}, 1fr)`; for (let i = 0; i < numQuestions; i++) { const wordDiv = document.createElement('div'); wordDiv.classList.add('progress-word'); topProgressBar.appendChild(wordDiv); } } else { ['1', '2'].forEach(p => { players[p].progressEl.style.gridTemplateColumns = `repeat(${numQuestions}, 1fr)`; for (let i = 0; i < numQuestions; i++) { const wordDiv = document.createElement('div'); wordDiv.classList.add('progress-word'); players[p].progressEl.appendChild(wordDiv); } }); } }
        function displayQuestion(player, question) { if (!question || !question.questionWord || !question.options) { console.error(`Geçersiz soru: P${player}, R${state.currentRound}`, question); endRound('error'); return; } if (!players[player] || !players[player].wordEl || !players[player].optionsEl) { console.error(`P${player} DOM elemanları yok!`); return; } players[player].wordEl.textContent = question.questionWord; players[player].optionsEl.innerHTML = ''; const shuffledOptions = shuffle([...question.options]); players[player].optionsEl.style.gridTemplateColumns = 'repeat(2, 1fr)'; shuffledOptions.forEach((opt) => { const optionDiv = document.createElement('div'); optionDiv.classList.add('option'); const charSpan = document.createElement('span'); charSpan.textContent = opt; optionDiv.appendChild(charSpan); optionDiv.onclick = (event) => handleAnswer(player, opt, question.correctForm, event.currentTarget); players[player].optionsEl.appendChild(optionDiv); }); }
        
        function handleAnswer(player, selectedOption, correctOption, clickedEl) { 
            if (gameMode === '2p' && state.playerResponses[player] !== null) return; 
            if (gameMode === '1p' && state.answers['1'].length > state.currentRound) return; 
             
            initAudio(); 
            if (state.currentRound < 0 || state.currentRound >= gameSettings.words) return; 
            const currentQuestion = state.playerQuestions[player] ? state.playerQuestions[player][state.currentRound] : null; 
            if (!currentQuestion) { console.error("handleAnswer: Soru yok!"); return; } 
            
            const isCorrect = selectedOption === correctOption; 
            const playerScreen = players[player].el; 
            if (!playerScreen) return; 
            
            if (isCorrect) { 
                playCorrectSound(); 
                playerScreen.classList.add('flash-correct'); 
                animateLetterFly(player, clickedEl); // <-- 1P ve 2P için animasyon
                if(players[player].wordEl) { 
                    setTimeout(() => { if(players[player].wordEl) players[player].wordEl.textContent = currentQuestion.word; }, 500); 
                } 
                setTimeout(() => playerScreen.classList.remove('flash-correct'), 600); 
            } else { 
                playIncorrectSound(); 
                playerScreen.classList.add('incorrect-answer-effect'); 
                setTimeout(() => playerScreen.classList.remove('incorrect-answer-effect'), 600); 
            } 
            
            highlightOptions(player, selectedOption, correctOption); 
            
            if (gameMode === '1p') { 
                state.answers['1'].push({ word: currentQuestion.word, correct: isCorrect }); 
                let p1Points = 0; 
                if (isCorrect) { 
                    p1Points = 5; 
                    showScorePopup('1', p1Points); // <-- 1P için puan animasyonu
                } 
                state.scores['1'] += p1Points; 
                players['1'].scoreEl.textContent = state.scores['1']; 
                const progressWords = topProgressBar.children; 
                if (progressWords && progressWords[state.currentRound]) { 
                    progressWords[state.currentRound].classList.add(isCorrect ? 'correct' : 'incorrect'); 
                } 
                setTimeout(nextQuestion, 1500); 
            } else { 
                state.playerResponses[player] = selectedOption; 
                state.responseTimes[player] = new Date().getTime(); 
                state.answers[player].push({ word: currentQuestion.word, correct: isCorrect, time: state.responseTimes[player] }); 
                const otherPlayer = player === '1' ? '2' : '1'; 
                if (state.playerResponses[otherPlayer] !== null) { 
                    updateScores(); setTimeout(nextQuestion, 2000); 
                } 
            } 
        }
        
        function highlightOptions(player, selected, correct) { const optionsContainer = players[player].optionsEl; if (!optionsContainer) return; const options = optionsContainer.children; for (let opt of options) { opt.classList.add('disabled'); if (opt.firstElementChild && opt.firstElementChild.textContent === correct) { opt.classList.add('correct'); } else if (opt.firstElementChild && opt.firstElementChild.textContent === selected) { opt.classList.add('incorrect'); } } }
        function updateScores() { if (state.currentRound < 0 || state.currentRound >= gameSettings.words) { console.warn("updateScores geçersiz tur:", state.currentRound); return; } const p1Q = state.playerQuestions['1'][state.currentRound]; const p1Correct = p1Q && state.playerResponses['1'] === p1Q.correctForm; const p2Q = state.playerQuestions['2'][state.currentRound]; const p2Correct = p2Q && state.playerResponses['2'] === p2Q.correctForm; let p1Pts = 0; let p2Pts = 0; const t1 = state.responseTimes['1']; const t2 = state.responseTimes['2']; if (p1Correct && p2Correct) { if (t1 < t2) { p1Pts = 10; p2Pts = 5; } else if (t2 < t1) { p1Pts = 5; p2Pts = 10; } else { p1Pts = 5; p2Pts = 5; } } else if (p1Correct && !p2Correct) { p1Pts = 10; p2Pts = 0; } else if (!p1Correct && p2Correct) { p1Pts = 0; p2Pts = 10; } else { p1Pts = 0; p2Pts = 0; } showScorePopup('1', p1Pts); showScorePopup('2', p2Pts); state.scores['1'] += p1Pts; state.scores['2'] += p2Pts; players['1'].scoreEl.textContent = state.scores['1']; players['2'].scoreEl.textContent = state.scores['2']; const p1Prg = players['1'].progressEl?.children; if (p1Prg && p1Prg[state.currentRound]) { p1Prg[state.currentRound].classList.add(p1Correct ? 'correct' : 'incorrect'); } const p2Prg = players['2'].progressEl?.children; if (p2Prg && p2Prg[state.currentRound]) { p2Prg[state.currentRound].classList.add(p2Correct ? 'correct' : 'incorrect'); } }
        
        function nextQuestion() { 
            state.currentRound++; 
            console.log("Next Round:", state.currentRound + 1, "/", gameSettings.words); 
            if (state.currentRound >= gameSettings.words) { 
                console.log("Oyun Bitti"); 
                endRound('completed'); 
                return; 
            } 
            if (gameMode === '1p') { 
                if (state.playerQuestions['1'] && state.playerQuestions['1'][state.currentRound]) { 
                    displayQuestion('1', state.playerQuestions['1'][state.currentRound]); 
                } else { 
                    console.error(`1P Soru ${state.currentRound} yüklenemedi!`); 
                    endRound('error'); 
                } 
            } else { 
                state.playerResponses = { '1': null, '2': null }; 
                state.responseTimes = { '1': null, '2': null }; 
                ['1', '2'].forEach(p => { 
                    if (state.playerQuestions && state.playerQuestions[p] && state.playerQuestions[p][state.currentRound]) { 
                        displayQuestion(p, state.playerQuestions[p][state.currentRound]); 
                    } else { 
                        console.error(`2P Soru P${p} R${state.currentRound} yüklenemedi!`); 
                        endRound('error'); 
                    } 
                }); 
            } 
            if (gameMode === '1p') {
                // Sayaç setupNewGame'de başladı. Sadece rengi kontrol et.
                if (p1TimerValueEl) {
                    p1TimerValueEl.style.color = (totalTimeLeft <= 10) ? '#dc3545' : '';
                }
            } 
        }
        function endRound(reason) { 
            console.log("endRound:", reason);
            stopGameTimer(); 
            modal.classList.add(gameMode === '1p' ? 'mode-1p' : 'mode-2p'); 
            modal.classList.remove(gameMode === '1p' ? 'mode-2p' : 'mode-1p'); 
            
            const numQuestionsAnswered = (state.answers && state.answers['1']) ? state.answers['1'].length : 0;
            const totalQuestions = gameSettings.words;
            const arabicNumerals = Array.from({length: totalQuestions}, (_, i) => (i + 1).toLocaleString('ar-EG')); 
            
            if (players['1'].resultsEl) players['1'].resultsEl.innerHTML = ''; else console.error("P1 sonuç elemanı yok!"); 
            const score1 = state.scores ? state.scores['1'] : 0; 
            const p1Answers = (state.answers && state.answers['1']) ? state.answers['1'] : []; 
            winnerText.lang = 'tr'; winnerText.dir = 'ltr'; 
            
            if (gameMode === '1p') {
                const correctCount = p1Answers.filter(a => a.correct).length;
                
                if (reason === 'timeup') {
                    winnerText.textContent = `Süre Bitti! Skor: ${score1}`;
                } else {
                    winnerText.textContent = `Tebrikler! Skor: ${score1}`;
                }

                const p1H3 = document.querySelector('#result-column-1 h3'); 
                if (p1H3) { p1H3.textContent = 'Sonuçların'; p1H3.lang = 'tr'; p1H3.dir = 'ltr'; } 
                const scoreDiv1 = document.createElement('div'); 
                scoreDiv1.className = 'flex items-center justify-center gap-2 text-3xl mb-2 w-full'; 
                scoreDiv1.innerHTML = `<span class="text-4xl">⭐</span><span>${score1}</span>`; 
                players['1'].resultsEl.appendChild(scoreDiv1); 
                
                const countDiv = document.createElement('div'); 
                countDiv.className = 'flex items-center justify-center gap-2 text-2xl mb-4 w-full text-gray-700'; 
                countDiv.dir = 'ltr'; 
                
                countDiv.innerHTML = `✓ ${correctCount} / ${numQuestionsAnswered} (Toplam: ${totalQuestions})`; 
                if (reason === 'completed') {
                     countDiv.innerHTML = `✓ ${correctCount} / ${totalQuestions}`; 
                }
                
                players['1'].resultsEl.appendChild(countDiv); 
                
                for(let i=0; i < p1Answers.length; i++){ 
                    const ans1 = p1Answers[i]; 
                    if (!ans1) continue; 
                    const div1 = document.createElement('div'); 
                    div1.classList.add('result-item'); 
                    const mark1 = ans1.correct ? '✓' : '✗'; 
                    div1.innerHTML = `<span lang="ar">${arabicNumerals[i]}</span><span lang="ar">${ans1.word}</span><span style="color: ${ans1.correct ? 'green' : 'red'};">${mark1}</span>`; 
                    players['1'].resultsEl.appendChild(div1); 
                } 
                document.getElementById('result-column-2').style.display = 'none'; 
                const grid1P = document.querySelector('#results-container .results-grid'); 
                if (grid1P) grid1P.style.gridTemplateColumns = '1fr'; 
            } else { 
                if (players['2'].resultsEl) players['2'].resultsEl.innerHTML = ''; else console.error("P2 sonuç elemanı yok!"); 
                document.getElementById('result-column-2').style.display = 'block'; 
                
                const p1H3 = document.querySelector('#result-column-1 h3'); 
                if (p1H3) { p1H3.textContent = 'الطّالِب ٢'; p1H3.lang = 'ar'; p1H3.dir = 'rtl'; } 
                const p2H3 = document.querySelector('#result-column-2 h3'); 
                if (p2H3) { p2H3.textContent = 'الطّالِب ١'; p2H3.lang = 'ar'; p2H3.dir = 'rtl'; } 
                
                const score2 = state.scores ? state.scores['2'] : 0; 
                if (score1 > score2) { 
                    triggerConfetti('1'); 
                    winnerText.textContent = `Oyuncu 2 Kazandı!`; 
                } else if (score2 > score1) { 
                    triggerConfetti('2'); 
                    winnerText.textContent = `Oyuncu 1 Kazandı!`; 
                } else { 
                    winnerText.textContent = 'Berabere!'; 
                } 
                const p2Answers = (state.answers && state.answers['2']) ? state.answers['2'] : []; 
                const scoreDiv1 = document.createElement('div'); 
                scoreDiv1.className = 'flex items-center justify-center gap-2 text-3xl mb-4 w-full'; 
                scoreDiv1.innerHTML = `<span class="text-4xl">⭐</span><span>${score1}</span>`; 
                players['1'].resultsEl.appendChild(scoreDiv1); 
                
                const scoreDiv2 = document.createElement('div'); 
                scoreDiv2.className = 'flex items-center justify-center gap-2 text-3xl mb-4 w-full'; 
                scoreDiv2.innerHTML = `<span class="text-4xl">⭐</span><span>${score2}</span>`; 
                players['2'].resultsEl.appendChild(scoreDiv2); 
                
                for(let i=0; i < totalQuestions; i++){ 
                    const ans1 = p1Answers[i]; const ans2 = p2Answers[i]; 
                    const word1 = ans1 ? ans1.word : "-"; 
                    const correct1 = ans1 ? ans1.correct : false; 
                    const time1 = ans1 ? ans1.time : Infinity; 
                    const word2 = ans2 ? ans2.word : "-"; 
                    const correct2 = ans2 ? ans2.correct : false; 
                    const time2 = ans2 ? ans2.time : Infinity; 
                    let p1Speed = false; let p2Speed = false; 
                    if (correct1 && correct2) { 
                        if (time1 < time2) p1Speed = true; 
                        else if (time2 < time1) p2Speed = true; 
                    } else if (correct1 && !correct2) { 
                        p1Speed = true; 
                    } else if (!correct1 && correct2) { 
                        p2Speed = true; 
                    } 
                    const icon = '⚡️'; 
                    const div1 = document.createElement('div'); 
                    div1.classList.add('result-item'); 
                    const mark1 = ans1 ? (correct1 ? '✓' : '✗') : '-'; 
                    div1.innerHTML = `<span lang="ar">${arabicNumerals[i]}</span><span lang="ar">${word1}</span><span style="color: ${correct1 ? 'green' : (ans1 ? 'red' : 'grey')};">${mark1}</span>${p1Speed ? `<span class="text-yellow-500">${icon}</span>` : ''}`; 
                    players['1'].resultsEl.appendChild(div1); 
                    
                    const div2 = document.createElement('div'); 
                    div2.classList.add('result-item'); 
                    const mark2 = ans2 ? (correct2 ? '✓' : '✗') : '-'; 
                    div2.innerHTML = `<span lang="ar">${arabicNumerals[i]}</span><span lang="ar">${word2}</span><span style="color: ${correct2 ? 'green' : (ans2 ? 'red' : 'grey')};">${mark2}</span>${p2Speed ? `<span class="text-yellow-500">${icon}</span>` : ''}`; 
                    if (players['2'].resultsEl) players['2'].resultsEl.appendChild(div2); 
                } 
            } 
            resultsWrapper.style.display = 'block'; 
            modal.style.display = 'flex'; 
        }

        function startIntroCountdown(callback) { console.log("Intro Countdown"); if (introCountdownInterval) clearInterval(introCountdownInterval); const nums = { '3': '٣', '2': '٢', '1': '١' }; let count = 3; countdownOverlay.classList.remove('hidden'); countdownNumber.textContent = nums[count]; introCountdownInterval = setInterval(() => { count--; if (count > 0) { countdownNumber.textContent = nums[count]; } else { clearInterval(introCountdownInterval); introCountdownInterval = null; countdownOverlay.classList.add('hidden'); if(callback) { callback(); } } }, 1000); }
        
        function start1PGame(difficulty) { 
            console.log("start1PGame:", difficulty); 
            let timerDuration = 0; 
            if (difficulty === 'easy') { timerDuration = 6; }       // 20 * 6 = 120 saniye (02:00)
            else if (difficulty === 'medium') { timerDuration = 4.5; } // 20 * 4.5 = 90 saniye (01:30)
            else if (difficulty === 'hard') { timerDuration = 3; }    // 20 * 3 = 60 saniye (01:00)
            
            gameSettings = { words: 20, difficulty: difficulty, timerDuration: timerDuration }; 
            document.body.classList.add('mode-1p'); 
            document.body.classList.remove('mode-2p'); 
            difficultyScreen.classList.add('hidden'); 
            gameWrapper.classList.remove('hidden'); 
            setupNewGame(); // 1P Geri sayım kaldırıldı, oyun doğrudan başlıyor
        }

        function returnToMenu() { 
            console.log("returnToMenu"); 
            if (introCountdownInterval) { 
                clearInterval(introCountdownInterval); 
                introCountdownInterval = null; 
                countdownOverlay.classList.add('hidden'); 
            } 
            stopGameTimer(); 
            state = {}; 
            modal.style.display = 'none'; 
            gameWrapper.classList.add('hidden'); 
            difficultyScreen.classList.add('hidden'); 
            rulesScreen.classList.remove('hidden'); 
            if (players['1'].wordEl) players['1'].wordEl.textContent = "..."; 
            if (players['2'].wordEl) players['2'].wordEl.textContent = "..."; 
            document.body.classList.remove('mode-1p'); 
            document.body.classList.add('mode-2p'); 
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM Loaded");
             // Geri dönme butonu
             if(backBtn) backBtn.onclick = returnToMenu; else console.error("backBtn yok!");

             // Mod seçme butonları
             if (start1PBtn) {
                 start1PBtn.onclick = () => { console.log("1P clicked"); gameMode = '1p'; rulesScreen.classList.add('hidden'); difficultyScreen.classList.remove('hidden'); };
             } else { console.error("start1PBtn yok!"); }
             if (start2PBtn) {
                 start2PBtn.onclick = () => { 
                     console.log("2P clicked"); 
                     gameMode = '2p'; 
                     gameSettings = { words: 10, difficulty: null, timerDuration: 0 }; 
                     document.body.classList.remove('mode-1p'); 
                     document.body.classList.add('mode-2p'); 
                     rulesScreen.classList.add('hidden'); 
                     gameWrapper.classList.remove('hidden'); 
                     startIntroCountdown(setupNewGame); // 2P Geri sayım hala aktif
                };
             } else { console.error("start2PBtn yok!"); }

             // Zorluk butonları
             if (easyBtn) easyBtn.onclick = () => start1PGame('easy'); else console.error("easyBtn yok!");
             if (mediumBtn) mediumBtn.onclick = () => start1PGame('medium'); else console.error("mediumBtn yok!");
             if (hardBtn) hardBtn.onclick = () => start1PGame('hard'); else console.error("hardBtn yok!");
        });
    </script>

    <script> /* Viewport Height Fix */ (function(){ function setAppHeight(){ document.documentElement.style.setProperty('--appH', window.innerHeight + 'px'); } setAppHeight(); window.addEventListener('resize', setAppHeight, { passive: true }); window.addEventListener('orientationchange', setAppHeight); })(); </script>
    <script id="mobile-boot-v2"> /* Mobile Boot Optimizations */ (function(){ function setVhUnit(){ const vh = window.visualViewport ? window.visualViewport.height * 0.01 : window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); } setVhUnit(); window.addEventListener('resize', setVhUnit); window.addEventListener('orientationchange', setVhUnit); function primeAudioOnce(){ try{ if (window.AudioContext || window.webkitAudioContext){ if (!window.__audioCtx) { window.__audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if (window.__audioCtx.state === 'suspended') { window.__audioCtx.resume && window.__audioCtx.resume(); } } }catch(e){} window.removeEventListener('touchstart', primeAudioOnce, {passive:true}); window.removeEventListener('click', primeAudioOnce, {passive:true}); } window.addEventListener('touchstart', primeAudioOnce, {passive:true, once:true}); window.addEventListener('click', primeAudioOnce, {passive:true, once:true}); const modal = document.getElementById('modal'); const rules = document.getElementById('rules-screen'); const difficulty = document.getElementById('difficulty-screen'); [modal, rules, difficulty].forEach(el=>{ if(!el) return; el.style.maxHeight = 'calc(var(--vh, 1vh) * 100)'; el.style.overflowY = 'auto'; }); })(); </script>

</body>
</html>